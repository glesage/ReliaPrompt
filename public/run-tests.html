<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Run Tests - LLM Prompt Testing Tool</title>
        <link rel="stylesheet" href="/styles.css" />
        <style>
            .score-card h3 {
                font-size: 14px;
                opacity: 0.9;
                margin-bottom: 5px;
                color: #fff;
            }
            .score-card .score {
                font-size: 36px;
                font-weight: bold;
            }
            .score-card.overall {
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            }
            .llm-results {
                display: grid;
                gap: 20px;
                margin-top: 20px;
            }
            .llm-result-card {
                border: 1px solid #eee;
                border-radius: 8px;
                padding: 15px;
            }
            .llm-result-card h4 {
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .score-badge {
                padding: 4px 12px;
                background: #d4edda;
                color: #155724;
                border-radius: 20px;
                font-size: 14px;
            }
            .score-badge.low {
                background: #f8d7da;
                color: #721c24;
            }
            .score-badge.medium {
                background: #fff3cd;
                color: #856404;
            }
            .test-case-detail {
                padding: 10px;
                border: 1px solid #eee;
                border-radius: 4px;
                margin-bottom: 10px;
                font-size: 13px;
            }
            .test-case-detail .header {
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
            }
            .correct-count {
                font-weight: 500;
            }
            .correct-count.success {
                color: #155724;
            }
            .correct-count.failure {
                color: #721c24;
            }
            .details-toggle {
                padding: 8px 16px;
                font-size: 12px;
                background: #f8f9fa;
                border: 1px solid #ddd;
                margin-top: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Run Tests</h1>
            <p class="subtitle">Test your prompts against all configured LLMs</p>

            <nav>
                <a href="/">Home</a>
                <a href="/config.html">Configuration</a>
                <a href="/prompts.html">Prompts</a>
                <a href="/test-cases.html">Test Cases</a>
                <a href="/run-tests.html" class="active">Run Tests</a>
                <a href="/improve.html">Auto-Improve</a>
            </nav>

            <div id="message"></div>

            <div class="card">
                <h2>Select Prompt to Test</h2>
                <div class="form-group">
                    <select id="prompt-select">
                        <option value="">-- Select a prompt --</option>
                    </select>
                </div>
                <div id="test-case-count" style="color: #666; margin-bottom: 15px"></div>
                <button id="run-btn" disabled>Run Tests</button>

                <div id="progress-section" class="progress-section hidden">
                    <div class="progress-label">Overall Progress</div>
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar" style="width: 0%">0%</div>
                    </div>
                    <div id="progress-details" style="color: #666; font-size: 14px"></div>
                </div>
            </div>

            <div id="results-section" class="hidden">
                <div class="card">
                    <h2>Results</h2>
                    <div id="score-cards"></div>
                    <div id="llm-results" class="llm-results"></div>
                </div>
            </div>
        </div>

        <script>
            let selectedPromptId = null;
            let pollInterval = null;

            async function loadPrompts() {
                try {
                    const res = await fetch("/api/prompts");
                    const prompts = await res.json();
                    const select = document.getElementById("prompt-select");
                    select.innerHTML =
                        '<option value="">-- Select a prompt --</option>' +
                        prompts
                            .map(
                                (p) => `<option value="${p.id}">${p.name} (v${p.version})</option>`
                            )
                            .join("");
                } catch (error) {
                    showMessage("Error loading prompts", "error");
                }
            }

            async function loadTestCaseCount() {
                if (!selectedPromptId) {
                    document.getElementById("test-case-count").textContent = "";
                    document.getElementById("run-btn").disabled = true;
                    return;
                }
                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/test-cases`);
                    const testCases = await res.json();
                    const count = testCases.length;
                    document.getElementById("test-case-count").textContent =
                        count > 0
                            ? `${count} test case(s) will be run 10 times each across all LLMs`
                            : "No test cases found";
                    document.getElementById("run-btn").disabled = count === 0;
                } catch (error) {
                    document.getElementById("test-case-count").textContent =
                        "Error loading test cases";
                    document.getElementById("run-btn").disabled = true;
                }
            }

            function showMessage(text, type) {
                const el = document.getElementById("message");
                el.innerHTML = `<div class="message ${type}">${text}</div>`;
                if (type !== "info") setTimeout(() => (el.innerHTML = ""), 5000);
            }

            async function runTests() {
                if (!selectedPromptId) return;
                document.getElementById("run-btn").disabled = true;
                document.getElementById("progress-section").classList.remove("hidden");
                document.getElementById("results-section").classList.add("hidden");
                showMessage("Starting test run...", "info");

                try {
                    const res = await fetch("/api/test/run", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ promptId: selectedPromptId }),
                    });
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || "Failed to start test run");
                    }
                    const { jobId } = await res.json();
                    pollProgress(jobId);
                } catch (error) {
                    showMessage(error.message, "error");
                    document.getElementById("run-btn").disabled = false;
                    document.getElementById("progress-section").classList.add("hidden");
                }
            }

            function pollProgress(jobId) {
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(async () => {
                    try {
                        const res = await fetch(`/api/test/status/${jobId}`);
                        const status = await res.json();
                        updateProgress(status);

                        if (status.status === "completed") {
                            clearInterval(pollInterval);
                            document.getElementById("run-btn").disabled = false;
                            document.getElementById("message").innerHTML = "";
                            showResults(status.results);
                        } else if (status.status === "failed") {
                            clearInterval(pollInterval);
                            document.getElementById("run-btn").disabled = false;
                            showMessage(status.error || "Test run failed", "error");
                        }
                    } catch (error) {
                        console.error("Error polling status:", error);
                    }
                }, 1000);
            }

            function updateProgress(status) {
                const progress = status.progress || 0;
                document.getElementById("progress-bar").style.width = progress + "%";
                document.getElementById("progress-bar").textContent = progress + "%";
                document.getElementById("progress-details").textContent =
                    `${status.completedTests || 0} / ${status.totalTests || 0} tests completed`;
            }

            function showResults(results) {
                if (!results) return;
                document.getElementById("results-section").classList.remove("hidden");

                document.getElementById("score-cards").innerHTML = `
                    <div class="score-card overall"><h3>Overall Score</h3><div class="score">${results.overallScore}%</div></div>
                    ${results.llmResults.map((llm) => `<div class="score-card"><h3>${llm.llmName}</h3><div class="score">${llm.score}%</div></div>`).join("")}
                `;

                document.getElementById("llm-results").innerHTML = results.llmResults
                    .map((llm) => {
                        const badgeClass =
                            llm.score >= 80 ? "" : llm.score >= 50 ? "medium" : "low";
                        return `
                        <div class="llm-result-card">
                            <h4>${llm.llmName} <span class="score-badge ${badgeClass}">${llm.correctCount}/${llm.totalRuns} correct (${llm.score}%)</span></h4>
                            <div id="details-${llm.llmName}" class="hidden">
                                ${llm.testCaseResults
                                    .map((tc, i) => {
                                        const successRate = (tc.correctRuns / tc.runs.length) * 100;
                                        const statusClass =
                                            successRate >= 80 ? "success" : "failure";
                                        return `
                                        <div class="test-case-detail">
                                            <div class="header"><strong>Test Case #${i + 1}</strong><span class="correct-count ${statusClass}">${tc.correctRuns}/${tc.runs.length} correct</span></div>
                                            <div style="margin-bottom: 5px;"><strong>Input:</strong></div>
                                            <div class="json-preview">${escapeHtml(tc.input.substring(0, 200))}${tc.input.length > 200 ? "..." : ""}</div>
                                            <div style="margin-top: 10px; margin-bottom: 5px;"><strong>Expected:</strong></div>
                                            <div class="json-preview">${formatJSON(tc.expectedOutput)}</div>
                                            ${tc.runs.some((r) => !r.isCorrect) ? `<div style="margin-top: 10px; margin-bottom: 5px;"><strong>Sample Wrong Output:</strong></div><div class="json-preview">${escapeHtml((tc.runs.find((r) => !r.isCorrect)?.actualOutput || "N/A").substring(0, 500))}</div>` : ""}
                                        </div>
                                    `;
                                    })
                                    .join("")}
                            </div>
                            <button class="details-toggle" onclick="toggleDetails('${llm.llmName}')">Show Details</button>
                        </div>
                    `;
                    })
                    .join("");
            }

            function toggleDetails(llmName) {
                const el = document.getElementById("details-" + llmName);
                const btn = el.parentElement.querySelector(".details-toggle");
                el.classList.toggle("hidden");
                btn.textContent = el.classList.contains("hidden") ? "Show Details" : "Hide Details";
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }
            function formatJSON(json) {
                try {
                    return escapeHtml(JSON.stringify(JSON.parse(json), null, 2));
                } catch {
                    return escapeHtml(json);
                }
            }

            document.getElementById("prompt-select").addEventListener("change", (e) => {
                selectedPromptId = e.target.value ? parseInt(e.target.value, 10) : null;
                loadTestCaseCount();
                document.getElementById("results-section").classList.add("hidden");
                document.getElementById("progress-section").classList.add("hidden");
            });

            document.getElementById("run-btn").addEventListener("click", runTests);
            loadPrompts();
        </script>
    </body>
</html>
