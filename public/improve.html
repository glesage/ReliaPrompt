<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Auto-Improve - LLM Prompt Testing Tool</title>
        <link rel="stylesheet" href="/styles.css" />
        <style>
            .progress-section {
                padding: 20px;
                background: #f8f9fa;
                border-radius: 8px;
            }
            .progress-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            .score-display {
                display: flex;
                gap: 30px;
                margin-bottom: 20px;
            }
            .score-item {
                text-align: center;
            }
            .score-item .label {
                font-size: 12px;
                color: #666;
                margin-bottom: 5px;
            }
            .score-item .value {
                font-size: 32px;
                font-weight: bold;
                color: #333;
            }
            .score-item .value.improved {
                color: #28a745;
            }
            .iteration-display {
                font-size: 14px;
                color: #666;
                margin-bottom: 15px;
            }
            .log-container pre {
                font-family: "Monaco", "Menlo", monospace;
                font-size: 12px;
                white-space: pre-wrap;
                margin: 0;
            }
            .log-line {
                padding: 2px 0;
            }
            .log-line.success {
                color: #4ec9b0;
            }
            .log-line.error {
                color: #f48771;
            }
            .log-line.info {
                color: #569cd6;
            }
            .improved-prompt-section {
                margin-top: 20px;
                padding: 20px;
                background: #e8f5e9;
                border-radius: 8px;
                border: 1px solid #c8e6c9;
            }
            .improved-prompt-section h3 {
                color: #2e7d32;
                margin-bottom: 15px;
            }
            .improved-prompt-section pre {
                background: #fff;
                padding: 15px;
                border-radius: 6px;
                font-family: "Monaco", "Menlo", monospace;
                font-size: 13px;
                white-space: pre-wrap;
                max-height: 300px;
                overflow-y: auto;
            }
            .inline-form {
                display: flex;
                gap: 15px;
                align-items: flex-end;
            }
            .inline-form .form-group {
                flex: 1;
                margin-bottom: 0;
            }
            .inline-form .form-group.small {
                flex: 0 0 150px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Auto-Improve Prompts</h1>
            <p class="subtitle">
                Let LLMs automatically improve your prompts based on test results
            </p>

            <nav>
                <a href="/">Home</a>
                <a href="/config.html">Configuration</a>
                <a href="/prompts.html">Prompts</a>
                <a href="/test-cases.html">Test Cases</a>
                <a href="/run-tests.html">Run Tests</a>
                <a href="/improve.html" class="active">Auto-Improve</a>
            </nav>

            <div id="message"></div>

            <div class="card">
                <h2>Start Improvement</h2>
                <div class="inline-form">
                    <div class="form-group">
                        <label for="prompt-select">Select Prompt</label>
                        <select id="prompt-select">
                            <option value="">-- Select a prompt --</option>
                        </select>
                    </div>
                    <div class="form-group small">
                        <label for="max-iterations">Max Iterations</label>
                        <input type="number" id="max-iterations" value="5" min="1" max="20" />
                    </div>
                    <button id="start-btn" disabled>Start Improvement</button>
                </div>
                <div
                    id="test-case-count"
                    style="color: #666; margin-top: 15px; font-size: 14px"
                ></div>
            </div>

            <div id="progress-section" class="card hidden">
                <div class="progress-header">
                    <h2>Improvement Progress</h2>
                    <span id="status-badge" class="status-badge running">Running</span>
                </div>

                <div class="score-display">
                    <div class="score-item">
                        <div class="label">Original Score</div>
                        <div id="original-score" class="value">--</div>
                    </div>
                    <div class="score-item">
                        <div class="label">Best Score</div>
                        <div id="best-score" class="value">--</div>
                    </div>
                    <div class="score-item">
                        <div class="label">Improvement</div>
                        <div id="improvement" class="value">--</div>
                    </div>
                </div>

                <div id="iteration-display" class="iteration-display">Iteration 0/0</div>

                <div class="log-container">
                    <pre id="log-output"></pre>
                </div>

                <div id="improved-prompt-section" class="improved-prompt-section hidden">
                    <h3>Improved Prompt (Saved as New Version)</h3>
                    <pre id="improved-prompt"></pre>
                </div>
            </div>
        </div>

        <script>
            let selectedPromptId = null;
            let pollInterval = null;

            async function loadPrompts() {
                try {
                    const res = await fetch("/api/prompts");
                    const prompts = await res.json();
                    const select = document.getElementById("prompt-select");
                    select.innerHTML =
                        '<option value="">-- Select a prompt --</option>' +
                        prompts
                            .map(
                                (p) => `<option value="${p.id}">${p.name} (v${p.version})</option>`
                            )
                            .join("");
                } catch (error) {
                    showMessage("Error loading prompts", "error");
                }
            }

            async function loadTestCaseCount() {
                if (!selectedPromptId) {
                    document.getElementById("test-case-count").textContent = "";
                    document.getElementById("start-btn").disabled = true;
                    return;
                }
                try {
                    const [tcRes, provRes] = await Promise.all([
                        fetch(`/api/prompts/${selectedPromptId}/test-cases`),
                        fetch("/api/config/providers"),
                    ]);
                    const testCases = await tcRes.json();
                    const providers = await provRes.json();
                    const tcCount = testCases.length;
                    const provCount = providers.count;

                    if (tcCount === 0) {
                        document.getElementById("test-case-count").textContent =
                            "No test cases found. Add test cases first.";
                        document.getElementById("start-btn").disabled = true;
                    } else if (provCount === 0) {
                        document.getElementById("test-case-count").textContent =
                            "No LLM providers configured. Add API keys first.";
                        document.getElementById("start-btn").disabled = true;
                    } else {
                        document.getElementById("test-case-count").textContent =
                            `${tcCount} test case(s) will be used with ${provCount} LLM provider(s): ${providers.providers.join(", ")}`;
                        document.getElementById("start-btn").disabled = false;
                    }
                } catch (error) {
                    document.getElementById("test-case-count").textContent = "Error loading info";
                    document.getElementById("start-btn").disabled = true;
                }
            }

            function showMessage(text, type) {
                const el = document.getElementById("message");
                el.innerHTML = `<div class="message ${type}">${text}</div>`;
                if (type !== "info") setTimeout(() => (el.innerHTML = ""), 5000);
            }

            async function startImprovement() {
                if (!selectedPromptId) return;
                const maxIterations = parseInt(document.getElementById("max-iterations").value, 10);

                document.getElementById("start-btn").disabled = true;
                document.getElementById("progress-section").classList.remove("hidden");
                document.getElementById("improved-prompt-section").classList.add("hidden");
                document.getElementById("log-output").textContent = "";
                document.getElementById("original-score").textContent = "--";
                document.getElementById("best-score").textContent = "--";
                document.getElementById("improvement").textContent = "--";
                document.getElementById("status-badge").className = "status-badge running";
                document.getElementById("status-badge").textContent = "Running";
                showMessage("Starting improvement...", "info");

                try {
                    const res = await fetch("/api/improve/start", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ promptId: selectedPromptId, maxIterations }),
                    });
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || "Failed to start improvement");
                    }
                    const { jobId } = await res.json();
                    pollProgress(jobId);
                } catch (error) {
                    showMessage(error.message, "error");
                    document.getElementById("start-btn").disabled = false;
                }
            }

            function pollProgress(jobId) {
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(async () => {
                    try {
                        const res = await fetch(`/api/improve/status/${jobId}`);
                        const status = await res.json();
                        updateProgress(status);

                        if (status.status === "completed") {
                            clearInterval(pollInterval);
                            document.getElementById("start-btn").disabled = false;
                            document.getElementById("message").innerHTML = "";
                            document.getElementById("status-badge").className =
                                "status-badge completed";
                            document.getElementById("status-badge").textContent = "Completed";
                            if (
                                status.bestPromptContent &&
                                status.bestScore > status.originalScore
                            ) {
                                document
                                    .getElementById("improved-prompt-section")
                                    .classList.remove("hidden");
                                document.getElementById("improved-prompt").textContent =
                                    status.bestPromptContent;
                            }
                        } else if (status.status === "failed") {
                            clearInterval(pollInterval);
                            document.getElementById("start-btn").disabled = false;
                            document.getElementById("status-badge").className =
                                "status-badge failed";
                            document.getElementById("status-badge").textContent = "Failed";
                            showMessage(status.error || "Improvement failed", "error");
                        }
                    } catch (error) {
                        console.error("Error polling status:", error);
                    }
                }, 2000);
            }

            function updateProgress(status) {
                document.getElementById("iteration-display").textContent =
                    `Iteration ${status.currentIteration}/${status.maxIterations}`;
                if (status.originalScore !== null)
                    document.getElementById("original-score").textContent =
                        status.originalScore + "%";
                if (status.bestScore !== null) {
                    document.getElementById("best-score").textContent = status.bestScore + "%";
                    if (status.originalScore !== null) {
                        const improvement = status.bestScore - status.originalScore;
                        const el = document.getElementById("improvement");
                        el.textContent = (improvement >= 0 ? "+" : "") + improvement + "%";
                        el.className = "value" + (improvement > 0 ? " improved" : "");
                    }
                }
                if (status.log && status.log.length > 0) {
                    const logEl = document.getElementById("log-output");
                    logEl.innerHTML = status.log
                        .map((line) => {
                            let cls = "";
                            if (line.includes("ERROR") || line.includes("Failed")) cls = "error";
                            else if (
                                line.includes("Score") ||
                                line.includes("improved") ||
                                line.includes("Perfect")
                            )
                                cls = "success";
                            else if (line.includes("Testing") || line.includes("Requesting"))
                                cls = "info";
                            return `<div class="log-line ${cls}">${escapeHtml(line)}</div>`;
                        })
                        .join("");
                    logEl.scrollTop = logEl.scrollHeight;
                }
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            document.getElementById("prompt-select").addEventListener("change", (e) => {
                selectedPromptId = e.target.value ? parseInt(e.target.value, 10) : null;
                loadTestCaseCount();
            });
            document.getElementById("start-btn").addEventListener("click", startImprovement);
            loadPrompts();
        </script>
    </body>
</html>
