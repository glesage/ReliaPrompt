<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Auto-Improve - Relia Prompt</title>
        <link rel="stylesheet" href="/styles.css" />
    </head>
    <body>
        <div class="app-layout app-shell" data-page="improve">
            <!-- Rail -->
            <aside class="app-rail" aria-label="Primary">
                <a class="app-rail-brand" href="/test-cases.html" aria-label="Relia Prompt Home">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        aria-hidden="true"
                    >
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                </a>
                <nav class="app-rail-nav" aria-label="Sections">
                    <a class="rail-link" href="/test-cases.html">
                        <span class="rail-link-label">Test Cases</span>
                    </a>
                    <a class="rail-link" href="/test-runs.html">
                        <span class="rail-link-label">Test Runs</span>
                    </a>
                    <a class="rail-link active" href="/improve.html" aria-current="page">
                        <span class="rail-link-label">Auto-Improve</span>
                    </a>
                </nav>
                <div class="app-rail-footer">
                    <button class="rail-btn" id="setup-btn" title="LLMs">LLMs</button>
                </div>
            </aside>

            <!-- Prompts Pane -->
            <aside class="app-pane app-pane-prompts" aria-label="Prompts">
                <div class="pane-header">
                    <div class="pane-title">Prompts</div>
                    <div class="pane-header-actions">
                        <button
                            class="btn btn-secondary btn-sm"
                            id="export-prompts-btn"
                            title="Export all prompts"
                        >
                            Export
                        </button>
                        <button
                            class="btn btn-secondary btn-sm"
                            id="import-prompts-btn"
                            title="Import prompts"
                        >
                            Import
                        </button>
                        <button class="btn btn-primary btn-sm" id="new-prompt-btn">New</button>
                    </div>
                </div>
                <div class="pane-search">
                    <input
                        id="prompt-filter"
                        type="search"
                        placeholder="Search promptsâ€¦"
                        autocomplete="off"
                    />
                    <div class="pane-search-hint">âŒ˜K</div>
                </div>
                <div class="pane-body">
                    <div class="sidebar-list" id="sidebar-prompts">
                        <div class="sidebar-empty">Loading...</div>
                    </div>
                </div>
            </aside>

            <!-- Content Pane -->
            <main class="app-pane app-pane-content" aria-label="Content">
                <header class="content-header">
                    <div class="content-header-main">
                        <h1 class="content-title">Auto-Improve</h1>
                        <p class="content-subtitle">
                            Iterate on your prompt using an improvement model + benchmark models.
                        </p>
                    </div>
                    <div class="content-actions">
                        <button id="template-open-btn" class="btn btn-secondary btn-sm">
                            Template
                        </button>
                    </div>
                </header>

                <div id="app-message"></div>

                <div class="content-body">
                    <!-- No Prompt Selected State -->
                    <div id="no-prompt-message" class="empty-state">
                        <div class="empty-state-icon" aria-hidden="true">ðŸ› </div>
                        <h3>Select a prompt</h3>
                        <p>Pick a prompt on the left to start an auto-improvement run.</p>
                    </div>

                    <!-- Improve Section (shown when prompt selected) -->
                    <div id="improve-section" class="hidden">
                        <div class="content-grid">
                            <section class="content-col">
                                <div class="card">
                                    <h2>Improve "<span id="selected-prompt-name"></span>"</h2>
                                    <div class="inline-form" style="margin-bottom: 16px">
                                        <div class="form-group small">
                                            <label for="max-iterations">Max Iterations</label>
                                            <input
                                                type="number"
                                                id="max-iterations"
                                                value="5"
                                                min="1"
                                                max="20"
                                            />
                                        </div>
                                        <div class="form-group small">
                                            <label for="runs-per-llm">Runs Per LLM</label>
                                            <input
                                                type="number"
                                                id="runs-per-llm"
                                                value="1"
                                                min="1"
                                                max="10"
                                            />
                                        </div>
                                        <button id="start-btn" disabled>Start Improvement</button>
                                    </div>

                                    <div
                                        class="model-selection-section"
                                        style="margin-bottom: 16px"
                                    >
                                        <label
                                            style="
                                                display: block;
                                                margin-bottom: 8px;
                                                font-weight: 500;
                                            "
                                        >
                                            Improvement Model:
                                            <span
                                                id="improvement-model-selected"
                                                style="
                                                    font-weight: normal;
                                                    color: var(--color-text-muted);
                                                "
                                                >(none selected)</span
                                            >
                                        </label>
                                        <p
                                            style="
                                                color: var(--color-text-muted);
                                                font-size: 0.85rem;
                                                margin-bottom: 8px;
                                            "
                                        >
                                            Select one model to generate prompt improvements
                                        </p>
                                        <div
                                            id="improvement-model-selection"
                                            class="model-selection-container"
                                        >
                                            <div class="no-models">Loading models...</div>
                                        </div>
                                    </div>

                                    <div
                                        class="model-selection-section"
                                        style="margin-bottom: 16px"
                                    >
                                        <label
                                            style="
                                                display: block;
                                                margin-bottom: 8px;
                                                font-weight: 500;
                                            "
                                        >
                                            Benchmark Models:
                                            <span
                                                id="benchmark-models-count"
                                                style="
                                                    font-weight: normal;
                                                    color: var(--color-text-muted);
                                                "
                                                >(0 selected)</span
                                            >
                                        </label>
                                        <p
                                            style="
                                                color: var(--color-text-muted);
                                                font-size: 0.85rem;
                                                margin-bottom: 8px;
                                            "
                                        >
                                            Select one or more models to benchmark improvements
                                        </p>
                                        <div
                                            id="benchmark-models-selection"
                                            class="model-selection-container"
                                        >
                                            <div class="no-models">Loading models...</div>
                                        </div>
                                    </div>

                                    <div
                                        id="test-case-count"
                                        style="color: var(--color-text-muted); font-size: 14px"
                                    ></div>
                                    <div class="helper-note" style="margin-top: 8px">
                                        Test cases are shared across all versions of this prompt.
                                    </div>
                                </div>
                            </section>

                            <section class="content-col">
                                <div id="progress-section" class="card hidden">
                                    <div class="progress-header">
                                        <h2>Improvement Progress</h2>
                                        <span id="status-badge" class="status-badge running"
                                            >Running</span
                                        >
                                    </div>

                                    <div class="score-display">
                                        <div class="score-item">
                                            <div class="label">Original Score</div>
                                            <div id="original-score" class="value">--</div>
                                        </div>
                                        <div class="score-item">
                                            <div class="label">Best Score</div>
                                            <div id="best-score" class="value">--</div>
                                        </div>
                                        <div class="score-item">
                                            <div class="label">Improvement</div>
                                            <div id="improvement" class="value">--</div>
                                        </div>
                                    </div>

                                    <div id="iteration-display" class="iteration-display">
                                        Iteration 0/0
                                    </div>

                                    <div class="log-container">
                                        <pre id="log-output"></pre>
                                    </div>

                                    <div
                                        id="improved-prompt-section"
                                        class="improved-prompt-section hidden"
                                    >
                                        <h3>Improved Prompt (Saved as New Version)</h3>
                                        <pre id="improved-prompt"></pre>
                                    </div>
                                </div>

                                <div id="previous-runs-section" class="card">
                                    <h2>Previous Improvement Runs</h2>
                                    <div id="previous-runs-list">
                                        <div class="muted">Loading...</div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Config Modal -->
        <div class="modal-overlay" id="config-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>LLM Configuration</h2>
                    <button class="modal-close" id="config-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="config-form">
                    <div id="config-message"></div>
                    <div class="modal-body">
                        <div class="provider-section">
                            <h3>
                                OpenAI
                                <span id="openai-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="openai_api_key"
                                    name="openai_api_key"
                                    placeholder="API Key (sk-...)"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                AWS Bedrock
                                <span id="bedrock-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_access_key_id"
                                    name="bedrock_access_key_id"
                                    placeholder="Access Key ID (AKIA...)"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_secret_access_key"
                                    name="bedrock_secret_access_key"
                                    placeholder="Secret Access Key"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_region"
                                    name="bedrock_region"
                                    placeholder="Region (e.g., ap-southeast-2)"
                                    value="ap-southeast-2"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Deepseek
                                <span id="deepseek-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="deepseek_api_key"
                                    name="deepseek_api_key"
                                    placeholder="API Key (sk-...)"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Gemini
                                <span id="gemini-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="gemini_api_key"
                                    name="gemini_api_key"
                                    placeholder="API Key"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Groq
                                <span id="groq-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="groq_api_key"
                                    name="groq_api_key"
                                    placeholder="API Key (gsk_...)"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                OpenRouter
                                <span id="openrouter-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="openrouter_api_key"
                                    name="openrouter_api_key"
                                    placeholder="API Key (sk-or-v1-...)"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeConfigModal()">
                            Cancel
                        </button>
                        <button type="submit">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New Prompt Modal -->
        <div class="modal-overlay" id="new-prompt-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>Create New Prompt</h2>
                    <button class="modal-close" id="new-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="new-prompt-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new-prompt-name">Prompt Name</label>
                            <input
                                type="text"
                                id="new-prompt-name"
                                name="name"
                                placeholder="e.g., extract-entities"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="new-prompt-content">Prompt Content</label>
                            <textarea
                                id="new-prompt-content"
                                name="content"
                                class="tall"
                                placeholder="Enter your system prompt here..."
                                required
                            ></textarea>
                        </div>
                        <div class="form-group">
                            <label for="new-prompt-schema">Expected Output Schema (JSON)</label>
                            <textarea
                                id="new-prompt-schema"
                                name="expectedSchema"
                                class="medium"
                                placeholder='{"type": "array", "items": {"type": "object", "properties": {"name": {"type": "string"}}}}'
                            ></textarea>
                            <small
                                >Optional. JSON Schema for structured LLM output (used with
                                response_format).</small
                            >
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeNewPromptModal()">
                            Cancel
                        </button>
                        <button type="submit">Create Prompt</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Prompt Modal -->
        <div class="modal-overlay" id="edit-prompt-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>
                        Edit "<span id="edit-prompt-name-display"></span>"
                        <span id="edit-prompt-version" class="badge badge-version"></span>
                    </h2>
                    <button class="modal-close" id="edit-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="edit-prompt-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="edit-prompt-content">Prompt Content</label>
                            <textarea
                                id="edit-prompt-content"
                                name="content"
                                class="tall"
                                placeholder="Enter your system prompt here..."
                                required
                            ></textarea>
                            <small>Saving will create a new version of this prompt</small>
                        </div>
                        <div class="form-group">
                            <label for="edit-prompt-schema">Expected Output Schema (JSON)</label>
                            <textarea
                                id="edit-prompt-schema"
                                name="expectedSchema"
                                class="medium"
                                placeholder='{"type": "array", "items": {"type": "object", "properties": {"name": {"type": "string"}}}}'
                            ></textarea>
                            <small>Optional. JSON Schema for structured LLM output.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeEditPromptModal()">
                            Cancel
                        </button>
                        <button type="submit">Save as New Version</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Prompt Modal -->
        <div class="modal-overlay" id="view-prompt-modal">
            <div class="modal modal-wide">
                <div class="modal-header">
                    <div class="modal-title-group">
                        <h2 id="view-prompt-name-display">Prompt</h2>
                        <span class="badge badge-version" id="view-prompt-version">v1</span>
                    </div>
                    <button class="modal-close" id="view-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Prompt Content</label>
                        <pre class="view-prompt-content" id="view-prompt-content"></pre>
                    </div>
                    <div class="form-group" id="view-prompt-schema-group" style="display: none">
                        <label>Expected Output Schema</label>
                        <pre class="view-prompt-content" id="view-prompt-schema"></pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary" onclick="closeViewPromptModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Improvement Template Modal -->
        <div class="modal-overlay" id="template-modal">
            <div class="modal modal-wide">
                <div class="modal-header">
                    <div class="modal-title-group">
                        <h2>Improvement Prompt Template</h2>
                        <span id="template-status" class="badge badge-version"
                            >(using default)</span
                        >
                    </div>
                    <button class="modal-close" id="template-close-btn" aria-label="Close">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--color-text-muted); margin-bottom: 12px">
                        Customize the prompt used to ask LLMs to improve your prompt. Placeholders:
                    </p>
                    <ul style="color: var(--color-text-muted); font-size: 13px; padding-left: 20px">
                        <li><code>{{CURRENT_PROMPT}}</code> - The prompt being improved</li>
                        <li><code>{{TEST_SUMMARY}}</code> - Pass/fail/score summary</li>
                        <li><code>{{FAILURE_ANALYSIS}}</code> - Missing/extra items count</li>
                        <li><code>{{FAILED_TEST_CASES}}</code> - Details of failed tests</li>
                        <li><code>{{ANALYSIS_HINTS}}</code> - Hints based on failure types</li>
                        <li><code>{{PREVIOUS_CHANGES}}</code> - Previous iterations summary</li>
                    </ul>
                    <div class="form-group" style="margin-top: 12px">
                        <textarea
                            id="improvement-template"
                            style="
                                min-height: 340px;
                                font-family: var(--font-mono);
                                font-size: 13px;
                            "
                        ></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary" id="reset-template-btn">
                        Reset to default
                    </button>
                    <button type="button" class="secondary" id="template-cancel-btn">Close</button>
                    <button type="button" id="save-template-btn">Save template</button>
                </div>
            </div>
        </div>

        <script src="/app.js"></script>
        <script>
            let selectedPromptId = null;
            let selectedPromptName = null;
            let pollInterval = null;
            let selectedImprovementModel = null;
            let selectedBenchmarkModels = [];

            // Listen for prompt selection from sidebar
            window.addEventListener("promptSelected", (e) => {
                selectedPromptId = e.detail.id;
                selectedPromptName = e.detail.name;
                updateUI();
                loadTestCaseCount();
                loadPreviousImprovementRuns();
            });

            // Listen for model selection changes (for benchmark models)
            window.addEventListener("modelsSelectionChanged", (e) => {
                updateBenchmarkModelsCount();
                updateStartButtonState();
            });

            // Check for initial selection
            window.addEventListener("promptsLoaded", async (e) => {
                const { prompts, selectedId } = e.detail;
                if (selectedId) {
                    const prompt = prompts.find((p) => p.id === selectedId);
                    if (prompt) {
                        selectedPromptId = prompt.id;
                        selectedPromptName = prompt.name;
                        updateUI();
                        loadTestCaseCount();
                        loadPreviousImprovementRuns();
                    } else {
                        // Stored selection no longer exists, clear it
                        AppUtils.setSelectedPromptId(null);
                        updateUI();
                    }
                } else {
                    // No selection stored, ensure "Select a Prompt" UI is shown
                    updateUI();
                }
                // Load models for the improve section
                await loadImproveModels();
            });

            async function loadImproveModels() {
                await AppUtils.loadAvailableModels();
                await AppUtils.loadSelectedModels();

                // Initialize benchmark models from saved selection if empty
                if (selectedBenchmarkModels.length === 0) {
                    const globalModels = AppUtils.getSelectedModels();
                    selectedBenchmarkModels = globalModels.map((m) => ({
                        provider: m.provider,
                        modelId: m.modelId,
                    }));
                }

                // Render improvement model selection (radio buttons)
                renderImprovementModelRadios();

                // Render benchmark models selection (checkboxes)
                renderBenchmarkModelCheckboxes();

                updateImprovementModelStatus();
                updateBenchmarkModelsCount();
                updateStartButtonState();
            }

            function renderImprovementModelRadios() {
                const container = document.getElementById("improvement-model-selection");
                if (!container) return;

                const availableModels = AppUtils.getAvailableModels();
                if (availableModels.length === 0) {
                    container.innerHTML =
                        '<div class="no-models">No models available. Configure API keys first.</div>';
                    return;
                }

                // Group by provider
                const grouped = {};
                for (const model of availableModels) {
                    if (!grouped[model.provider]) {
                        grouped[model.provider] = [];
                    }
                    grouped[model.provider].push(model);
                }

                let html = "";
                for (const [provider, models] of Object.entries(grouped)) {
                    html += `<div class="model-provider-group"><h4>${escapeHtml(provider)}</h4>`;
                    html += '<div class="model-list">';
                    for (const model of models) {
                        const isChecked =
                            selectedImprovementModel &&
                            selectedImprovementModel.provider === model.provider &&
                            selectedImprovementModel.modelId === model.id;
                        html += `
                            <label class="model-checkbox">
                                <input type="radio" 
                                       name="improvement-model"
                                       data-provider="${escapeHtml(model.provider)}" 
                                       data-model-id="${escapeHtml(model.id)}"
                                       ${isChecked ? "checked" : ""}>
                                <span class="model-name">${escapeHtml(model.name)}</span>
                            </label>
                        `;
                    }
                    html += "</div></div>";
                }

                container.innerHTML = html;

                // Add event listeners
                container.querySelectorAll('input[type="radio"]').forEach((radio) => {
                    radio.addEventListener("change", () => {
                        if (radio.checked) {
                            selectedImprovementModel = {
                                provider: radio.dataset.provider,
                                modelId: radio.dataset.modelId,
                            };
                            updateImprovementModelStatus();
                            updateStartButtonState();
                        }
                    });
                });
            }

            function renderBenchmarkModelCheckboxes() {
                const container = document.getElementById("benchmark-models-selection");
                if (!container) return;

                const availableModels = AppUtils.getAvailableModels();
                if (availableModels.length === 0) {
                    container.innerHTML =
                        '<div class="no-models">No models available. Configure API keys first.</div>';
                    return;
                }

                // Group by provider
                const grouped = {};
                for (const model of availableModels) {
                    if (!grouped[model.provider]) {
                        grouped[model.provider] = [];
                    }
                    grouped[model.provider].push(model);
                }

                let html = "";
                for (const [provider, models] of Object.entries(grouped)) {
                    html += `<div class="model-provider-group"><h4>${escapeHtml(provider)}</h4>`;
                    html += '<div class="model-list">';
                    for (const model of models) {
                        const isChecked = selectedBenchmarkModels.some(
                            (m) => m.provider === model.provider && m.modelId === model.id
                        );
                        html += `
                            <label class="model-checkbox">
                                <input type="checkbox" 
                                       data-provider="${escapeHtml(model.provider)}" 
                                       data-model-id="${escapeHtml(model.id)}"
                                       ${isChecked ? "checked" : ""}>
                                <span class="model-name">${escapeHtml(model.name)}</span>
                            </label>
                        `;
                    }
                    html += "</div></div>";
                }

                container.innerHTML = html;

                // Add event listeners
                container.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
                    checkbox.addEventListener("change", () => {
                        const provider = checkbox.dataset.provider;
                        const modelId = checkbox.dataset.modelId;
                        const model = { provider, modelId };

                        if (checkbox.checked) {
                            if (
                                !selectedBenchmarkModels.some(
                                    (m) => m.provider === provider && m.modelId === modelId
                                )
                            ) {
                                selectedBenchmarkModels.push(model);
                            }
                        } else {
                            selectedBenchmarkModels = selectedBenchmarkModels.filter(
                                (m) => !(m.provider === provider && m.modelId === modelId)
                            );
                        }
                        updateBenchmarkModelsCount();
                        updateStartButtonState();
                    });
                });
            }

            function updateImprovementModelStatus() {
                const statusEl = document.getElementById("improvement-model-selected");
                if (selectedImprovementModel) {
                    const availableModels = AppUtils.getAvailableModels();
                    const model = availableModels.find(
                        (m) =>
                            m.provider === selectedImprovementModel.provider &&
                            m.id === selectedImprovementModel.modelId
                    );
                    statusEl.textContent = model ? `(${model.name})` : "(selected)";
                } else {
                    statusEl.textContent = "(none selected)";
                }
            }

            function updateBenchmarkModelsCount() {
                const count = selectedBenchmarkModels.length;
                document.getElementById("benchmark-models-count").textContent =
                    `(${count} selected)`;
            }

            function updateUI() {
                const hasSelection = !!selectedPromptId;
                document
                    .getElementById("improve-section")
                    .classList.toggle("hidden", !hasSelection);
                document
                    .getElementById("no-prompt-message")
                    .classList.toggle("hidden", hasSelection);
                if (selectedPromptName) {
                    document.getElementById("selected-prompt-name").textContent =
                        selectedPromptName;
                }
            }

            function updateStartButtonState() {
                const countEl = document.getElementById("test-case-count");
                const testCaseCount = countEl.dataset.count
                    ? parseInt(countEl.dataset.count, 10)
                    : 0;
                const hasImprovementModel = !!selectedImprovementModel;
                const hasBenchmarkModels = selectedBenchmarkModels.length > 0;
                document.getElementById("start-btn").disabled =
                    testCaseCount === 0 || !hasImprovementModel || !hasBenchmarkModels;
            }

            async function loadTestCaseCount() {
                if (!selectedPromptId) {
                    document.getElementById("test-case-count").textContent = "";
                    document.getElementById("test-case-count").dataset.count = "";
                    updateStartButtonState();
                    return;
                }
                try {
                    const tcRes = await fetch(`/api/prompts/${selectedPromptId}/test-cases`);
                    const testCases = await tcRes.json();
                    const tcCount = testCases.length;
                    const benchmarkCount = selectedBenchmarkModels.length;

                    document.getElementById("test-case-count").dataset.count = tcCount;

                    if (tcCount === 0) {
                        document.getElementById("test-case-count").textContent =
                            "No test cases found. Add test cases first.";
                    } else if (!selectedImprovementModel) {
                        document.getElementById("test-case-count").textContent =
                            `${tcCount} test case(s) available. Select an improvement model and benchmark models to start.`;
                    } else if (benchmarkCount === 0) {
                        document.getElementById("test-case-count").textContent =
                            `${tcCount} test case(s) available. Select at least one benchmark model to start.`;
                    } else {
                        document.getElementById("test-case-count").textContent =
                            `${tcCount} test case(s) will be used with ${benchmarkCount} benchmark model(s)`;
                    }
                    updateStartButtonState();
                } catch (error) {
                    document.getElementById("test-case-count").textContent = "Error loading info";
                    document.getElementById("start-btn").disabled = true;
                }
            }

            async function startImprovement() {
                if (!selectedPromptId) return;

                if (!selectedImprovementModel) {
                    AppUtils.showAppMessage("Please select an improvement model", "error");
                    return;
                }

                if (selectedBenchmarkModels.length === 0) {
                    AppUtils.showAppMessage("Please select at least one benchmark model", "error");
                    return;
                }

                const maxIterations = parseInt(document.getElementById("max-iterations").value, 10);
                const runsPerLlm = parseInt(document.getElementById("runs-per-llm").value, 10);

                document.getElementById("start-btn").disabled = true;
                document.getElementById("progress-section").classList.remove("hidden");
                document.getElementById("improved-prompt-section").classList.add("hidden");
                document.getElementById("log-output").textContent = "";
                document.getElementById("original-score").textContent = "--";
                document.getElementById("best-score").textContent = "--";
                document.getElementById("improvement").textContent = "--";
                document.getElementById("status-badge").className = "status-badge running";
                document.getElementById("status-badge").textContent = "Running";
                AppUtils.showAppMessage("Starting improvement...", "info");

                try {
                    const res = await fetch("/api/improve/start", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            promptId: selectedPromptId,
                            maxIterations,
                            runsPerLlm,
                            improvementModel: selectedImprovementModel,
                            benchmarkModels: selectedBenchmarkModels,
                        }),
                    });
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || "Failed to start improvement");
                    }
                    const { jobId } = await res.json();
                    pollProgress(jobId);
                } catch (error) {
                    AppUtils.showAppMessage(error.message, "error");
                    document.getElementById("start-btn").disabled = false;
                }
            }

            function pollProgress(jobId) {
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(async () => {
                    try {
                        const res = await fetch(`/api/improve/status/${jobId}`);
                        const status = await res.json();
                        updateProgress(status);

                        if (status.status === "completed") {
                            clearInterval(pollInterval);
                            document.getElementById("start-btn").disabled = false;
                            document.getElementById("app-message").innerHTML = "";
                            document.getElementById("status-badge").className =
                                "status-badge completed";
                            document.getElementById("status-badge").textContent = "Completed";
                            if (
                                status.bestPromptContent &&
                                status.bestScore > status.originalScore
                            ) {
                                document
                                    .getElementById("improved-prompt-section")
                                    .classList.remove("hidden");
                                document.getElementById("improved-prompt").textContent =
                                    status.bestPromptContent;
                            }
                            loadPreviousImprovementRuns();
                        } else if (status.status === "failed") {
                            clearInterval(pollInterval);
                            document.getElementById("start-btn").disabled = false;
                            document.getElementById("status-badge").className =
                                "status-badge failed";
                            document.getElementById("status-badge").textContent = "Failed";
                            AppUtils.showAppMessage(status.error || "Improvement failed", "error");
                            loadPreviousImprovementRuns();
                        }
                    } catch (error) {
                        AppUtils.showAppMessage("Error checking improvement status", "error");
                    }
                }, 2000);
            }

            function updateProgress(status) {
                document.getElementById("iteration-display").textContent =
                    `Iteration ${status.currentIteration}/${status.maxIterations}`;
                if (status.originalScore !== null) {
                    const originalScorePercent = AppUtils.scoreToPercent(status.originalScore);
                    document.getElementById("original-score").textContent =
                        originalScorePercent + "%";
                }
                if (status.bestScore !== null) {
                    const bestScorePercent = AppUtils.scoreToPercent(status.bestScore);
                    document.getElementById("best-score").textContent = bestScorePercent + "%";
                    if (status.originalScore !== null) {
                        const originalScorePercent = AppUtils.scoreToPercent(status.originalScore);
                        const improvement = bestScorePercent - originalScorePercent;
                        const el = document.getElementById("improvement");
                        el.textContent = (improvement >= 0 ? "+" : "") + improvement + "%";
                        el.className = "value" + (improvement > 0 ? " improved" : "");
                    }
                }
                if (status.log && status.log.length > 0) {
                    const logEl = document.getElementById("log-output");
                    logEl.innerHTML = status.log
                        .map((line) => {
                            let cls = "";
                            if (line.includes("ERROR") || line.includes("Failed")) cls = "error";
                            else if (
                                line.includes("Score") ||
                                line.includes("improved") ||
                                line.includes("Perfect")
                            )
                                cls = "success";
                            else if (line.includes("Testing") || line.includes("Requesting"))
                                cls = "info";
                            return `<div class="log-line ${cls}">${escapeHtml(line)}</div>`;
                        })
                        .join("");
                    logEl.scrollTop = logEl.scrollHeight;
                }
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            document.getElementById("start-btn").addEventListener("click", startImprovement);

            // Template editor state
            let defaultTemplate = "";

            async function loadImprovementTemplate() {
                try {
                    const res = await fetch("/api/config/improvement-prompt");
                    const data = await res.json();
                    defaultTemplate = data.defaultTemplate;
                    document.getElementById("improvement-template").value = data.template;
                    updateTemplateStatus(data.template, data.defaultTemplate);
                } catch (error) {
                    console.error("Error loading improvement template:", error);
                }
            }

            function updateTemplateStatus(current, defaultTpl) {
                const statusEl = document.getElementById("template-status");
                if (current.trim() === defaultTpl.trim()) {
                    statusEl.textContent = "(using default)";
                    statusEl.style.color = "var(--color-text-muted)";
                } else {
                    statusEl.textContent = "(customized)";
                    statusEl.style.color = "var(--color-success)";
                }
            }

            function openTemplateModal() {
                const overlay = document.getElementById("template-modal");
                overlay.classList.add("active");
                loadImprovementTemplate();
                document.getElementById("improvement-template")?.focus();
            }

            function closeTemplateModal() {
                const overlay = document.getElementById("template-modal");
                overlay.classList.remove("active");
            }

            async function saveTemplate() {
                const template = document.getElementById("improvement-template").value;
                try {
                    const res = await fetch("/api/config/improvement-prompt", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ template }),
                    });
                    if (res.ok) {
                        AppUtils.showAppMessage("Template saved!", "success");
                        updateTemplateStatus(template, defaultTemplate);
                    } else {
                        const error = await res.json();
                        AppUtils.showAppMessage(error.error || "Failed to save template", "error");
                    }
                } catch (error) {
                    AppUtils.showAppMessage("Error saving template", "error");
                }
            }

            async function resetTemplate() {
                if (!confirm("Reset the improvement prompt template to the default?")) return;
                document.getElementById("improvement-template").value = defaultTemplate;
                try {
                    const res = await fetch("/api/config/improvement-prompt", {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ template: defaultTemplate }),
                    });
                    if (res.ok) {
                        AppUtils.showAppMessage("Template reset to default!", "success");
                        updateTemplateStatus(defaultTemplate, defaultTemplate);
                    }
                } catch (error) {
                    AppUtils.showAppMessage("Error resetting template", "error");
                }
            }

            document
                .getElementById("template-open-btn")
                .addEventListener("click", openTemplateModal);
            document
                .getElementById("template-close-btn")
                .addEventListener("click", closeTemplateModal);
            document
                .getElementById("template-cancel-btn")
                .addEventListener("click", closeTemplateModal);
            document.getElementById("save-template-btn").addEventListener("click", saveTemplate);
            document.getElementById("reset-template-btn").addEventListener("click", resetTemplate);

            // Close modal on overlay click
            document.getElementById("template-modal").addEventListener("click", (e) => {
                if (e.target === e.currentTarget) closeTemplateModal();
            });

            // Close modal on Escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") closeTemplateModal();
            });

            // Load template on page load
            loadImprovementTemplate();

            async function loadPreviousImprovementRuns() {
                const container = document.getElementById("previous-runs-list");
                if (!selectedPromptId) {
                    container.innerHTML =
                        '<div class="muted">Select a prompt to see previous improvement runs</div>';
                    return;
                }

                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/improvement-jobs`);
                    const jobs = await res.json();

                    if (jobs.length === 0) {
                        container.innerHTML =
                            '<div class="muted">No previous improvement runs for this prompt</div>';
                        return;
                    }

                    container.innerHTML = jobs
                        .map((job) => {
                            const date = new Date(job.createdAt);
                            const formattedDate =
                                date.toLocaleDateString() + " " + date.toLocaleTimeString();
                            const statusClass =
                                job.status === "completed"
                                    ? "success"
                                    : job.status === "failed"
                                      ? "failure"
                                      : "pending";
                            const statusText =
                                job.status.charAt(0).toUpperCase() + job.status.slice(1);

                            let scoreHtml = "";
                            if (job.bestScore !== null && job.bestScore !== undefined) {
                                const scorePercent = AppUtils.scoreToPercent(job.bestScore);
                                const badgeClass =
                                    scorePercent >= 90 ? "" : scorePercent >= 80 ? "medium" : "low";
                                scoreHtml = `<span class="score-badge ${badgeClass}" data-tooltip="Best Score">${scorePercent}%</span>`;
                            }

                            return `
                            <div class="previous-run-item" data-job-id="${job.id}" onclick="viewPreviousImprovementRun('${job.id}')">
                                <div class="previous-run-info">
                                    <span class="previous-run-date">${escapeHtml(formattedDate)}</span>
                                    <span class="previous-run-tests">${job.currentIteration}/${job.maxIterations} iterations</span>
                                </div>
                                <div class="previous-run-status">
                                    ${scoreHtml}
                                    <span class="tag tag-${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        `;
                        })
                        .join("");
                } catch (error) {
                    container.innerHTML = '<div class="muted">Failed to load previous runs</div>';
                }
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            async function viewPreviousImprovementRun(jobId) {
                try {
                    const res = await fetch(`/api/improve/status/${jobId}`);
                    const status = await res.json();

                    // Show the progress section with the previous run's data
                    document.getElementById("progress-section").classList.remove("hidden");
                    document.getElementById("improved-prompt-section").classList.add("hidden");

                    // Update status badge
                    const badge = document.getElementById("status-badge");
                    badge.className = `status-badge ${status.status}`;
                    badge.textContent =
                        status.status.charAt(0).toUpperCase() + status.status.slice(1);

                    // Update scores
                    if (status.originalScore !== null && status.originalScore !== undefined) {
                        document.getElementById("original-score").textContent =
                            AppUtils.scoreToPercent(status.originalScore) + "%";
                    } else {
                        document.getElementById("original-score").textContent = "--";
                    }
                    if (status.bestScore !== null && status.bestScore !== undefined) {
                        document.getElementById("best-score").textContent =
                            AppUtils.scoreToPercent(status.bestScore) + "%";
                    } else {
                        document.getElementById("best-score").textContent = "--";
                    }

                    // Calculate improvement
                    if (
                        status.originalScore !== null &&
                        status.bestScore !== null &&
                        status.originalScore !== undefined &&
                        status.bestScore !== undefined
                    ) {
                        const improvement = AppUtils.scoreToPercent(
                            status.bestScore - status.originalScore
                        );
                        const sign = improvement >= 0 ? "+" : "";
                        document.getElementById("improvement").textContent =
                            sign + improvement + "%";
                    } else {
                        document.getElementById("improvement").textContent = "--";
                    }

                    // Update iteration display
                    document.getElementById("iteration-display").textContent =
                        `Iteration ${status.currentIteration}/${status.maxIterations}`;

                    // Update log
                    const logOutput = document.getElementById("log-output");
                    logOutput.textContent = (status.log || []).join("\n");
                    logOutput.scrollTop = logOutput.scrollHeight;

                    // Show improved prompt if available
                    if (status.bestPromptContent) {
                        document
                            .getElementById("improved-prompt-section")
                            .classList.remove("hidden");
                        document.getElementById("improved-prompt").textContent =
                            status.bestPromptContent;
                    }
                } catch (error) {
                    AppUtils.showAppMessage("Error loading improvement run", "error");
                }
            }

            // Initialize
            updateUI();
        </script>
    </body>
</html>
