<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Auto-Improve - Relia Prompt</title>
        <link rel="stylesheet" href="/styles.css" />
    </head>
    <body>
        <div class="app-layout">
            <!-- Navbar -->
            <nav class="navbar">
                <a href="/test-cases.html" class="navbar-brand">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                    <span>Relia Prompt</span>
                </a>
                <div class="navbar-nav hidden">
                    <a href="/test-cases.html">Test Cases</a>
                    <a href="/test-runs.html">Test Runs</a>
                    <a href="/improve.html" class="active">Auto-Improve</a>
                </div>
                <div class="navbar-actions">
                    <button class="btn-text" id="setup-btn" title="LLMs">LLMs</button>
                </div>
            </nav>

            <div class="app-body">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <div class="sidebar-header">
                        <h3>Prompts</h3>
                        <button class="btn-new-prompt" id="new-prompt-btn">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            <span>New Prompt</span>
                        </button>
                    </div>
                    <div class="sidebar-list" id="sidebar-prompts">
                        <div class="sidebar-empty">Loading...</div>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="main-content">
                    <div id="app-message"></div>

                    <div class="page-header">
                        <h1>Auto-Improve Prompts</h1>
                        <p>Let LLMs automatically improve your prompts based on test results</p>
                    </div>

                    <!-- No Prompt Selected State -->
                    <div id="no-prompt-message" class="no-prompt-selected">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                            <polyline points="10 9 9 9 8 9" />
                        </svg>
                        <h3>Select a Prompt</h3>
                        <p>Choose a prompt from the sidebar to start auto-improvement</p>
                    </div>

                    <!-- Improve Section (shown when prompt selected) -->
                    <div id="improve-section" class="hidden">
                        <div class="card">
                            <h2>Improve "<span id="selected-prompt-name"></span>"</h2>
                            <div class="inline-form" style="margin-bottom: 16px">
                                <div class="form-group small">
                                    <label for="max-iterations">Max Iterations</label>
                                    <input
                                        type="number"
                                        id="max-iterations"
                                        value="5"
                                        min="1"
                                        max="20"
                                    />
                                </div>
                                <div class="form-group small">
                                    <label for="runs-per-llm">Runs Per LLM</label>
                                    <input
                                        type="number"
                                        id="runs-per-llm"
                                        value="1"
                                        min="1"
                                        max="10"
                                    />
                                </div>
                                <button id="start-btn" disabled>Start Improvement</button>
                            </div>
                            <div
                                id="test-case-count"
                                style="color: var(--color-text-muted); font-size: 14px"
                            ></div>
                        </div>

                        <div id="progress-section" class="card hidden">
                            <div class="progress-header">
                                <h2>Improvement Progress</h2>
                                <span id="status-badge" class="status-badge running">Running</span>
                            </div>

                            <div class="score-display">
                                <div class="score-item">
                                    <div class="label">Original Score</div>
                                    <div id="original-score" class="value">--</div>
                                </div>
                                <div class="score-item">
                                    <div class="label">Best Score</div>
                                    <div id="best-score" class="value">--</div>
                                </div>
                                <div class="score-item">
                                    <div class="label">Improvement</div>
                                    <div id="improvement" class="value">--</div>
                                </div>
                            </div>

                            <div id="iteration-display" class="iteration-display">
                                Iteration 0/0
                            </div>

                            <div class="log-container">
                                <pre id="log-output"></pre>
                            </div>

                            <div
                                id="improved-prompt-section"
                                class="improved-prompt-section hidden"
                            >
                                <h3>Improved Prompt (Saved as New Version)</h3>
                                <pre id="improved-prompt"></pre>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Config Modal -->
        <div class="modal-overlay" id="config-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>LLM Configuration</h2>
                    <button class="modal-close" id="config-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="config-form">
                    <div id="config-message"></div>
                    <div class="modal-body">
                        <div class="provider-section">
                            <h3>
                                OpenAI
                                <span id="openai-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="openai_api_key"
                                    name="openai_api_key"
                                    placeholder="API Key (sk-...)"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                AWS Bedrock
                                <span id="bedrock-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_access_key_id"
                                    name="bedrock_access_key_id"
                                    placeholder="Access Key ID (AKIA...)"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_secret_access_key"
                                    name="bedrock_secret_access_key"
                                    placeholder="Secret Access Key"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_region"
                                    name="bedrock_region"
                                    placeholder="Region (e.g., ap-southeast-2)"
                                    value="ap-southeast-2"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Deepseek
                                <span id="deepseek-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="deepseek_api_key"
                                    name="deepseek_api_key"
                                    placeholder="API Key (sk-...)"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeConfigModal()">
                            Cancel
                        </button>
                        <button type="submit">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New Prompt Modal -->
        <div class="modal-overlay" id="new-prompt-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>Create New Prompt</h2>
                    <button class="modal-close" id="new-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="new-prompt-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new-prompt-name">Prompt Name</label>
                            <input
                                type="text"
                                id="new-prompt-name"
                                name="name"
                                placeholder="e.g., extract-entities"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="new-prompt-content">Prompt Content</label>
                            <textarea
                                id="new-prompt-content"
                                name="content"
                                class="tall"
                                placeholder="Enter your system prompt here..."
                                required
                            ></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeNewPromptModal()">
                            Cancel
                        </button>
                        <button type="submit">Create Prompt</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Prompt Modal -->
        <div class="modal-overlay" id="edit-prompt-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>
                        Edit "<span id="edit-prompt-name-display"></span>"
                        <span id="edit-prompt-version" class="badge badge-version"></span>
                    </h2>
                    <button class="modal-close" id="edit-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="edit-prompt-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="edit-prompt-content">Prompt Content</label>
                            <textarea
                                id="edit-prompt-content"
                                name="content"
                                class="tall"
                                placeholder="Enter your system prompt here..."
                                required
                            ></textarea>
                            <small>Saving will create a new version of this prompt</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeEditPromptModal()">
                            Cancel
                        </button>
                        <button type="submit">Save as New Version</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Prompt Modal -->
        <div class="modal-overlay" id="view-prompt-modal">
            <div class="modal modal-wide">
                <div class="modal-header">
                    <div class="modal-title-group">
                        <h2 id="view-prompt-name-display">Prompt</h2>
                        <span class="badge badge-version" id="view-prompt-version">v1</span>
                    </div>
                    <button class="modal-close" id="view-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <pre class="view-prompt-content" id="view-prompt-content"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary" onclick="closeViewPromptModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <script src="/app.js"></script>
        <script>
            let selectedPromptId = null;
            let selectedPromptName = null;
            let pollInterval = null;

            // Listen for prompt selection from sidebar
            window.addEventListener("promptSelected", (e) => {
                selectedPromptId = e.detail.id;
                selectedPromptName = e.detail.name;
                updateUI();
                loadTestCaseCount();
            });

            // Check for initial selection
            window.addEventListener("promptsLoaded", (e) => {
                const { prompts, selectedId } = e.detail;
                if (selectedId) {
                    const prompt = prompts.find((p) => p.id === selectedId);
                    if (prompt) {
                        selectedPromptId = prompt.id;
                        selectedPromptName = prompt.name;
                        updateUI();
                        loadTestCaseCount();
                    } else {
                        // Stored selection no longer exists, clear it
                        AppUtils.setSelectedPromptId(null);
                        updateUI();
                    }
                } else {
                    // No selection stored, ensure "Select a Prompt" UI is shown
                    updateUI();
                }
            });

            function updateUI() {
                const hasSelection = !!selectedPromptId;
                document
                    .getElementById("improve-section")
                    .classList.toggle("hidden", !hasSelection);
                document
                    .getElementById("no-prompt-message")
                    .classList.toggle("hidden", hasSelection);
                document.querySelector(".navbar-nav").classList.toggle("hidden", !hasSelection);
                if (selectedPromptName) {
                    document.getElementById("selected-prompt-name").textContent =
                        selectedPromptName;
                }
            }

            async function loadTestCaseCount() {
                if (!selectedPromptId) {
                    document.getElementById("test-case-count").textContent = "";
                    document.getElementById("start-btn").disabled = true;
                    return;
                }
                try {
                    const [tcRes, provRes] = await Promise.all([
                        fetch(`/api/prompts/${selectedPromptId}/test-cases`),
                        fetch("/api/config/providers"),
                    ]);
                    const testCases = await tcRes.json();
                    const providers = await provRes.json();
                    const tcCount = testCases.length;
                    const provCount = providers.count;

                    if (tcCount === 0) {
                        document.getElementById("test-case-count").textContent =
                            "No test cases found. Add test cases first.";
                        document.getElementById("start-btn").disabled = true;
                    } else if (provCount === 0) {
                        document.getElementById("test-case-count").textContent =
                            "No LLM providers configured. Add API keys first.";
                        document.getElementById("start-btn").disabled = true;
                    } else {
                        document.getElementById("test-case-count").textContent =
                            `${tcCount} test case(s) will be used with ${provCount} LLM provider(s): ${providers.providers.join(", ")}`;
                        document.getElementById("start-btn").disabled = false;
                    }
                } catch (error) {
                    document.getElementById("test-case-count").textContent = "Error loading info";
                    document.getElementById("start-btn").disabled = true;
                }
            }

            async function startImprovement() {
                if (!selectedPromptId) return;
                const maxIterations = parseInt(document.getElementById("max-iterations").value, 10);
                const runsPerLlm = parseInt(document.getElementById("runs-per-llm").value, 10);

                document.getElementById("start-btn").disabled = true;
                document.getElementById("progress-section").classList.remove("hidden");
                document.getElementById("improved-prompt-section").classList.add("hidden");
                document.getElementById("log-output").textContent = "";
                document.getElementById("original-score").textContent = "--";
                document.getElementById("best-score").textContent = "--";
                document.getElementById("improvement").textContent = "--";
                document.getElementById("status-badge").className = "status-badge running";
                document.getElementById("status-badge").textContent = "Running";
                AppUtils.showAppMessage("Starting improvement...", "info");

                try {
                    const res = await fetch("/api/improve/start", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ promptId: selectedPromptId, maxIterations, runsPerLlm }),
                    });
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || "Failed to start improvement");
                    }
                    const { jobId } = await res.json();
                    pollProgress(jobId);
                } catch (error) {
                    AppUtils.showAppMessage(error.message, "error");
                    document.getElementById("start-btn").disabled = false;
                }
            }

            function pollProgress(jobId) {
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(async () => {
                    try {
                        const res = await fetch(`/api/improve/status/${jobId}`);
                        const status = await res.json();
                        updateProgress(status);

                        if (status.status === "completed") {
                            clearInterval(pollInterval);
                            document.getElementById("start-btn").disabled = false;
                            document.getElementById("app-message").innerHTML = "";
                            document.getElementById("status-badge").className =
                                "status-badge completed";
                            document.getElementById("status-badge").textContent = "Completed";
                            if (
                                status.bestPromptContent &&
                                status.bestScore > status.originalScore
                            ) {
                                document
                                    .getElementById("improved-prompt-section")
                                    .classList.remove("hidden");
                                document.getElementById("improved-prompt").textContent =
                                    status.bestPromptContent;
                            }
                        } else if (status.status === "failed") {
                            clearInterval(pollInterval);
                            document.getElementById("start-btn").disabled = false;
                            document.getElementById("status-badge").className =
                                "status-badge failed";
                            document.getElementById("status-badge").textContent = "Failed";
                            AppUtils.showAppMessage(status.error || "Improvement failed", "error");
                        }
                    } catch (error) {
                        AppUtils.showAppMessage("Error checking improvement status", "error");
                    }
                }, 2000);
            }

            function updateProgress(status) {
                document.getElementById("iteration-display").textContent =
                    `Iteration ${status.currentIteration}/${status.maxIterations}`;
                if (status.originalScore !== null)
                    document.getElementById("original-score").textContent =
                        status.originalScore + "%";
                if (status.bestScore !== null) {
                    document.getElementById("best-score").textContent = status.bestScore + "%";
                    if (status.originalScore !== null) {
                        const improvement = status.bestScore - status.originalScore;
                        const el = document.getElementById("improvement");
                        el.textContent = (improvement >= 0 ? "+" : "") + improvement + "%";
                        el.className = "value" + (improvement > 0 ? " improved" : "");
                    }
                }
                if (status.log && status.log.length > 0) {
                    const logEl = document.getElementById("log-output");
                    logEl.innerHTML = status.log
                        .map((line) => {
                            let cls = "";
                            if (line.includes("ERROR") || line.includes("Failed")) cls = "error";
                            else if (
                                line.includes("Score") ||
                                line.includes("improved") ||
                                line.includes("Perfect")
                            )
                                cls = "success";
                            else if (line.includes("Testing") || line.includes("Requesting"))
                                cls = "info";
                            return `<div class="log-line ${cls}">${escapeHtml(line)}</div>`;
                        })
                        .join("");
                    logEl.scrollTop = logEl.scrollHeight;
                }
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            document.getElementById("start-btn").addEventListener("click", startImprovement);

            // Initialize
            updateUI();
        </script>
    </body>
</html>
