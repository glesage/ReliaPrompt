<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test Cases - LLM Prompt Testing Tool</title>
        <link rel="stylesheet" href="/styles.css" />
        <style>
            .test-case-item {
                padding: 15px;
                border: 1px solid #eee;
                border-radius: 6px;
                position: relative;
                margin-bottom: 15px;
            }
            .test-case-item.editing {
                border-color: #007bff;
                background: #f8f9ff;
            }
            .test-case-item h4 {
                margin-bottom: 10px;
            }
            .test-case-item .label {
                font-weight: 500;
                color: #555;
                margin-bottom: 5px;
            }
            .test-case-item .json-preview {
                max-height: 150px;
                overflow: auto;
                margin-bottom: 10px;
            }
            .test-case-item .action-buttons button {
                padding: 5px 10px;
                font-size: 12px;
            }
            .no-prompt-selected {
                padding: 40px;
                text-align: center;
                color: #666;
            }
            .edit-form {
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #ddd;
            }
            .edit-form .form-group textarea {
                min-height: 80px;
            }
            .button-group {
                display: flex;
                gap: 10px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Test Cases</h1>
            <p class="subtitle">Define test inputs and expected JSON outputs for your prompts</p>

            <nav>
                <a href="/">Home</a>
                <a href="/config.html">Configuration</a>
                <a href="/prompts.html">Prompts</a>
                <a href="/test-cases.html" class="active">Test Cases</a>
                <a href="/run-tests.html">Run Tests</a>
                <a href="/improve.html">Auto-Improve</a>
            </nav>

            <div id="message"></div>

            <div class="card">
                <h2>Select Prompt</h2>
                <div class="form-group">
                    <select id="prompt-select">
                        <option value="">-- Select a prompt --</option>
                    </select>
                </div>
            </div>

            <div id="test-case-section" class="hidden">
                <div class="card">
                    <h2>Add Test Case</h2>
                    <form id="test-case-form">
                        <div class="form-group">
                            <label for="input">Input (User Message)</label>
                            <textarea
                                id="input"
                                name="input"
                                placeholder="The text or data to send to the LLM..."
                            ></textarea>
                            <small>This will be sent as the user message to the LLM</small>
                        </div>
                        <div class="form-group">
                            <label for="expected_output">Expected Output (JSON)</label>
                            <textarea
                                id="expected_output"
                                name="expected_output"
                                placeholder='{"key": "value"}'
                            ></textarea>
                            <small
                                >Must be valid JSON. The LLM's response will be compared against
                                this.</small
                            >
                        </div>
                        <button type="submit">Add Test Case</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Existing Test Cases</h2>
                    <div id="test-cases-list">
                        <p style="color: #666">No test cases yet.</p>
                    </div>
                </div>
            </div>

            <div id="no-prompt-message" class="card no-prompt-selected">
                <p>Select a prompt to manage its test cases</p>
            </div>
        </div>

        <script>
            let selectedPromptId = null;
            let editingTestCaseId = null;
            let testCasesData = [];

            async function loadPrompts() {
                try {
                    const res = await fetch("/api/prompts");
                    const prompts = await res.json();
                    const select = document.getElementById("prompt-select");
                    select.innerHTML =
                        '<option value="">-- Select a prompt --</option>' +
                        prompts
                            .map(
                                (p) => `<option value="${p.id}">${p.name} (v${p.version})</option>`
                            )
                            .join("");
                } catch (error) {
                    showMessage("Error loading prompts", "error");
                }
            }

            async function loadTestCases() {
                if (!selectedPromptId) return;
                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/test-cases`);
                    testCasesData = await res.json();
                    renderTestCases();
                } catch (error) {
                    document.getElementById("test-cases-list").innerHTML =
                        '<p style="color: red;">Error loading test cases</p>';
                }
            }

            function renderTestCases() {
                const container = document.getElementById("test-cases-list");
                if (testCasesData.length === 0) {
                    container.innerHTML =
                        '<p style="color: #666;">No test cases yet. Add your first one above!</p>';
                    return;
                }

                container.innerHTML = testCasesData
                    .map((tc, i) => {
                        if (editingTestCaseId === tc.id) {
                            return `
                            <div class="test-case-item editing" data-id="${tc.id}">
                                <h4>Test Case #${i + 1} - Editing</h4>
                                <div class="edit-form">
                                    <div class="form-group">
                                        <label>Input (User Message)</label>
                                        <textarea id="edit-input-${tc.id}">${escapeHtml(tc.input)}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Expected Output (JSON)</label>
                                        <textarea id="edit-output-${tc.id}">${escapeHtml(tc.expected_output)}</textarea>
                                    </div>
                                    <div class="button-group">
                                        <button class="success" onclick="saveTestCase(${tc.id})">Save</button>
                                        <button class="secondary" onclick="cancelEdit()">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        }
                        return `
                        <div class="test-case-item" data-id="${tc.id}">
                            <div class="action-buttons">
                                <button onclick="startEdit(${tc.id})">Edit</button>
                                <button class="danger" onclick="deleteTestCase(${tc.id})">Delete</button>
                            </div>
                            <h4>Test Case #${i + 1}</h4>
                            <div class="label">Input:</div>
                            <div class="json-preview">${escapeHtml(tc.input)}</div>
                            <div class="label">Expected Output:</div>
                            <div class="json-preview">${formatJSON(tc.expected_output)}</div>
                        </div>
                    `;
                    })
                    .join("");
            }

            function startEdit(id) {
                editingTestCaseId = id;
                renderTestCases();
            }
            function cancelEdit() {
                editingTestCaseId = null;
                renderTestCases();
            }

            async function saveTestCase(id) {
                const input = document.getElementById(`edit-input-${id}`).value.trim();
                const expected_output = document.getElementById(`edit-output-${id}`).value.trim();
                try {
                    JSON.parse(expected_output);
                } catch {
                    showMessage("Expected output must be valid JSON", "error");
                    return;
                }

                try {
                    const res = await fetch(`/api/test-cases/${id}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ input, expected_output }),
                    });
                    if (res.ok) {
                        showMessage("Test case updated!", "success");
                        editingTestCaseId = null;
                        loadTestCases();
                    } else {
                        const error = await res.json();
                        showMessage(error.error || "Failed to update test case", "error");
                    }
                } catch (error) {
                    showMessage("Error updating test case", "error");
                }
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }
            function formatJSON(json) {
                try {
                    return escapeHtml(JSON.stringify(JSON.parse(json), null, 2));
                } catch {
                    return escapeHtml(json);
                }
            }
            function showMessage(text, type) {
                const el = document.getElementById("message");
                el.innerHTML = `<div class="message ${type}">${text}</div>`;
                setTimeout(() => (el.innerHTML = ""), 5000);
            }

            async function deleteTestCase(id) {
                if (!confirm("Are you sure you want to delete this test case?")) return;
                try {
                    const res = await fetch(`/api/test-cases/${id}`, { method: "DELETE" });
                    if (res.ok) {
                        showMessage("Test case deleted", "success");
                        loadTestCases();
                    } else {
                        showMessage("Failed to delete test case", "error");
                    }
                } catch (error) {
                    showMessage("Error deleting test case", "error");
                }
            }

            document.getElementById("prompt-select").addEventListener("change", (e) => {
                selectedPromptId = e.target.value ? parseInt(e.target.value, 10) : null;
                editingTestCaseId = null;
                document
                    .getElementById("test-case-section")
                    .classList.toggle("hidden", !selectedPromptId);
                document
                    .getElementById("no-prompt-message")
                    .classList.toggle("hidden", !!selectedPromptId);
                if (selectedPromptId) loadTestCases();
            });

            document.getElementById("test-case-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                if (!selectedPromptId) {
                    showMessage("Please select a prompt first", "error");
                    return;
                }

                const input = document.getElementById("input").value.trim();
                const expected_output = document.getElementById("expected_output").value.trim();
                try {
                    JSON.parse(expected_output);
                } catch {
                    showMessage("Expected output must be valid JSON", "error");
                    return;
                }

                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/test-cases`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ input, expected_output }),
                    });
                    if (res.ok) {
                        showMessage("Test case added!", "success");
                        document.getElementById("test-case-form").reset();
                        loadTestCases();
                    } else {
                        const error = await res.json();
                        showMessage(error.error || "Failed to add test case", "error");
                    }
                } catch (error) {
                    showMessage("Error adding test case", "error");
                }
            });

            loadPrompts();
        </script>
    </body>
</html>
