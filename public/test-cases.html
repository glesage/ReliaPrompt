<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test Cases - Relia Prompt</title>
        <link rel="stylesheet" href="/styles.css" />
    </head>
    <body>
        <div class="app-layout">
            <!-- Navbar -->
            <nav class="navbar">
                <a href="/test-cases.html" class="navbar-brand">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                    >
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                    <span>Relia Prompt</span>
                </a>
                <div class="navbar-nav hidden">
                    <a href="/test-cases.html" class="active">Test Cases</a>
                    <a href="/test-runs.html">Test Runs</a>
                    <a href="/improve.html">Auto-Improve</a>
                </div>
                <div class="navbar-actions">
                    <button class="btn-text" id="setup-btn" title="LLMs">LLMs</button>
                </div>
            </nav>

            <div class="app-body">
                <!-- Sidebar -->
                <aside class="sidebar">
                    <div class="sidebar-header">
                        <h3>Prompts</h3>
                        <button class="btn-new-prompt" id="new-prompt-btn">
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <line x1="12" y1="5" x2="12" y2="19" />
                                <line x1="5" y1="12" x2="19" y2="12" />
                            </svg>
                            <span>New Prompt</span>
                        </button>
                    </div>
                    <div class="sidebar-list" id="sidebar-prompts">
                        <div class="sidebar-empty">Loading...</div>
                    </div>
                </aside>

                <!-- Main Content -->
                <main class="main-content">
                    <div id="app-message"></div>

                    <div class="page-header">
                        <div class="page-header-row">
                            <h1>Test Cases</h1>
                            <div class="button-group" style="display: flex; gap: 0.5rem">
                                <button id="export-test-cases-btn" class="hidden secondary">
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        style="width: 16px; height: 16px"
                                    >
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                        <polyline points="7 10 12 15 17 10" />
                                        <line x1="12" y1="15" x2="12" y2="3" />
                                    </svg>
                                    Export
                                </button>
                                <button id="import-test-cases-btn" class="hidden secondary">
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        style="width: 16px; height: 16px"
                                    >
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                        <polyline points="17 8 12 3 7 8" />
                                        <line x1="12" y1="3" x2="12" y2="15" />
                                    </svg>
                                    Import
                                </button>
                                <button id="add-test-case-btn" class="hidden">
                                    <svg
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        style="width: 16px; height: 16px"
                                    >
                                        <line x1="12" y1="5" x2="12" y2="19" />
                                        <line x1="5" y1="12" x2="19" y2="12" />
                                    </svg>
                                    Add Test Case
                                </button>
                            </div>
                        </div>
                        <p>Define test inputs and expected JSON outputs for your prompts</p>
                        <p
                            id="shared-test-cases-note"
                            class="hidden"
                            style="
                                color: var(--color-text-muted);
                                font-size: 0.85rem;
                                margin-top: 0.5rem;
                            "
                        >
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                style="
                                    width: 14px;
                                    height: 14px;
                                    vertical-align: middle;
                                    margin-right: 4px;
                                "
                            >
                                <circle cx="12" cy="12" r="10" />
                                <line x1="12" y1="16" x2="12" y2="12" />
                                <line x1="12" y1="8" x2="12.01" y2="8" />
                            </svg>
                            Test cases are shared across all versions of this prompt
                        </p>
                    </div>

                    <!-- No Prompt Selected State -->
                    <div id="no-prompt-message" class="no-prompt-selected">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                            <polyline points="10 9 9 9 8 9" />
                        </svg>
                        <h3>Select a Prompt</h3>
                        <p>Choose a prompt from the sidebar to manage its test cases</p>
                    </div>

                    <!-- Test Case Section (shown when prompt selected) -->
                    <div id="test-case-section" class="hidden">
                        <span id="selected-prompt-name" class="hidden"></span>
                        <div id="test-cases-list">
                            <p style="color: var(--color-text-muted)">No test cases yet.</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- Config Modal -->
        <div class="modal-overlay" id="config-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>LLM Configuration</h2>
                    <button class="modal-close" id="config-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="config-form">
                    <div id="config-message"></div>
                    <div class="modal-body">
                        <div class="provider-section">
                            <h3>
                                OpenAI
                                <span id="openai-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="openai_api_key"
                                    name="openai_api_key"
                                    placeholder="API Key (sk-...)"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                AWS Bedrock
                                <span id="bedrock-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_access_key_id"
                                    name="bedrock_access_key_id"
                                    placeholder="Access Key ID (AKIA...)"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_secret_access_key"
                                    name="bedrock_secret_access_key"
                                    placeholder="Secret Access Key"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_region"
                                    name="bedrock_region"
                                    placeholder="Region (e.g., ap-southeast-2)"
                                    value="ap-southeast-2"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Deepseek
                                <span id="deepseek-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="deepseek_api_key"
                                    name="deepseek_api_key"
                                    placeholder="API Key (sk-...)"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Gemini
                                <span id="gemini-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="gemini_api_key"
                                    name="gemini_api_key"
                                    placeholder="API Key"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Groq
                                <span id="groq-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="groq_api_key"
                                    name="groq_api_key"
                                    placeholder="API Key (gsk_...)"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                OpenRouter
                                <span id="openrouter-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="openrouter_api_key"
                                    name="openrouter_api_key"
                                    placeholder="API Key (sk-or-v1-...)"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeConfigModal()">
                            Cancel
                        </button>
                        <button type="submit">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New Prompt Modal -->
        <div class="modal-overlay" id="new-prompt-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>Create New Prompt</h2>
                    <button class="modal-close" id="new-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="new-prompt-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new-prompt-name">Prompt Name</label>
                            <input
                                type="text"
                                id="new-prompt-name"
                                name="name"
                                placeholder="e.g., extract-entities"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="new-prompt-content">Prompt Content</label>
                            <textarea
                                id="new-prompt-content"
                                name="content"
                                class="tall"
                                placeholder="Enter your system prompt here..."
                                required
                            ></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeNewPromptModal()">
                            Cancel
                        </button>
                        <button type="submit">Create Prompt</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Prompt Modal -->
        <div class="modal-overlay" id="edit-prompt-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>
                        Edit "<span id="edit-prompt-name-display"></span>"
                        <span id="edit-prompt-version" class="badge badge-version"></span>
                    </h2>
                    <button class="modal-close" id="edit-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="edit-prompt-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="edit-prompt-content">Prompt Content</label>
                            <textarea
                                id="edit-prompt-content"
                                name="content"
                                class="tall"
                                placeholder="Enter your system prompt here..."
                                required
                            ></textarea>
                            <small>Saving will create a new version of this prompt</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeEditPromptModal()">
                            Cancel
                        </button>
                        <button type="submit">Save as New Version</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Prompt Modal -->
        <div class="modal-overlay" id="view-prompt-modal">
            <div class="modal modal-wide">
                <div class="modal-header">
                    <div class="modal-title-group">
                        <h2 id="view-prompt-name-display">Prompt</h2>
                        <span class="badge badge-version" id="view-prompt-version">v1</span>
                    </div>
                    <button class="modal-close" id="view-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <pre class="view-prompt-content" id="view-prompt-content"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary" onclick="closeViewPromptModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Test Case Modal -->
        <div class="modal-overlay" id="add-test-case-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>Add Test Case</h2>
                    <button class="modal-close" id="add-test-case-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="test-case-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="input">Input (User Message)</label>
                            <textarea
                                id="input"
                                name="input"
                                placeholder="The text or data to send to the LLM..."
                            ></textarea>
                            <small>This will be sent as the user message to the LLM</small>
                        </div>
                        <div class="form-group">
                            <label for="expected_output">Expected Output (JSON)</label>
                            <textarea
                                id="expected_output"
                                name="expected_output"
                                placeholder='{"key": "value"}'
                            ></textarea>
                            <small
                                >Must be valid JSON. The LLM's response will be compared against
                                this.</small
                            >
                        </div>
                        <div class="form-group">
                            <label for="expected_output_type">Expected Output Type</label>
                            <select id="expected_output_type" name="expected_output_type">
                                <option value="string">String</option>
                                <option value="array" selected>Array</option>
                                <option value="object">Object</option>
                            </select>
                            <small>The type of data structure expected from the LLM</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeAddTestCaseModal()">
                            Cancel
                        </button>
                        <button type="submit">Save</button>
                    </div>
                </form>
            </div>
        </div>

        <script src="/app.js"></script>
        <script>
            let selectedPromptId = null;
            let selectedPromptName = null;
            let editingTestCaseId = null;
            let testCasesData = [];

            // Listen for prompt selection from sidebar
            window.addEventListener("promptSelected", (e) => {
                selectedPromptId = e.detail.id;
                selectedPromptName = e.detail.name;
                editingTestCaseId = null;
                updateUI();
                loadTestCases();
            });

            // Check for initial selection
            window.addEventListener("promptsLoaded", (e) => {
                const { prompts, selectedId } = e.detail;
                if (selectedId) {
                    const prompt = prompts.find((p) => p.id === selectedId);
                    if (prompt) {
                        selectedPromptId = prompt.id;
                        selectedPromptName = prompt.name;
                        updateUI();
                        loadTestCases();
                    } else {
                        // Stored selection no longer exists, clear it
                        AppUtils.setSelectedPromptId(null);
                        updateUI();
                    }
                } else {
                    // No selection stored, ensure "Select a Prompt" UI is shown
                    updateUI();
                }
            });

            function updateUI() {
                const hasSelection = !!selectedPromptId;
                document
                    .getElementById("test-case-section")
                    .classList.toggle("hidden", !hasSelection);
                document
                    .getElementById("no-prompt-message")
                    .classList.toggle("hidden", hasSelection);
                document
                    .getElementById("add-test-case-btn")
                    .classList.toggle("hidden", !hasSelection);
                document
                    .getElementById("export-test-cases-btn")
                    .classList.toggle("hidden", !hasSelection);
                document
                    .getElementById("import-test-cases-btn")
                    .classList.toggle("hidden", !hasSelection);
                document
                    .getElementById("shared-test-cases-note")
                    .classList.toggle("hidden", !hasSelection);
                document.querySelector(".navbar-nav").classList.toggle("hidden", !hasSelection);
                if (selectedPromptName) {
                    document.getElementById("selected-prompt-name").textContent =
                        selectedPromptName;
                }
            }

            async function loadTestCases() {
                if (!selectedPromptId) return;
                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/test-cases`);
                    testCasesData = await res.json();
                    renderTestCases();
                } catch (error) {
                    document.getElementById("test-cases-list").innerHTML =
                        '<p style="color: var(--color-danger);">Error loading test cases</p>';
                }
            }

            function renderTestCases() {
                const container = document.getElementById("test-cases-list");
                if (testCasesData.length === 0) {
                    container.innerHTML =
                        '<p style="color: var(--color-text-muted);">No test cases yet. Add your first one above!</p>';
                    return;
                }

                container.innerHTML = testCasesData
                    .map((tc, i) => {
                        // Handle both camelCase and snake_case property names
                        const outputType = tc.expectedOutputType || tc.expected_output_type;
                        if (editingTestCaseId === tc.id) {
                            return `
                            <div class="test-case-item editing" data-id="${tc.id}">
                                <h4>Test Case #${i + 1} - Editing</h4>
                                <div class="edit-form">
                                    <div class="form-group">
                                        <label>Input (User Message)</label>
                                        <textarea id="edit-input-${tc.id}">${escapeHtml(tc.input)}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Expected Output (JSON)</label>
                                        <textarea id="edit-output-${tc.id}">${escapeHtml(tc.expectedOutput)}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Expected Output Type</label>
                                        <select id="edit-output-type-${tc.id}">
                                            <option value="string" ${(tc.expectedOutputType || tc.expected_output_type) === "string" ? "selected" : ""}>String</option>
                                            <option value="array" ${(tc.expectedOutputType || tc.expected_output_type) === "array" || (!tc.expectedOutputType && !tc.expected_output_type) ? "selected" : ""}>Array</option>
                                            <option value="object" ${(tc.expectedOutputType || tc.expected_output_type) === "object" ? "selected" : ""}>Object</option>
                                        </select>
                                    </div>
                                    <div class="button-group">
                                        <button class="success" onclick="saveTestCase(${tc.id})">Save</button>
                                        <button class="secondary" onclick="cancelEdit()">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        }
                        return `
                        <div class="test-case-item" data-id="${tc.id}">
                            <div class="test-case-header">
                                <h4>Test Case #${i + 1}</h4>
                                <div class="action-buttons">
                                    <button onclick="startEdit(${tc.id})">Edit</button>
                                    <button class="danger" onclick="deleteTestCase(${tc.id})">Delete</button>
                                </div>
                            </div>
                            <div class="label">Input:</div>
                            <div class="json-preview">${escapeHtml(tc.input)}</div>
                            <div class="label">Expected Output (${formatOutputType(outputType)}):</div>
                            <div class="json-preview">${formatJSON(tc.expectedOutput)}</div>
                        </div>
                    `;
                    })
                    .join("");
            }

            function startEdit(id) {
                editingTestCaseId = id;
                renderTestCases();
            }

            function cancelEdit() {
                editingTestCaseId = null;
                renderTestCases();
            }

            async function saveTestCase(id) {
                const input = document.getElementById(`edit-input-${id}`).value.trim();
                const expected_output = document.getElementById(`edit-output-${id}`).value.trim();
                const expected_output_type = document.getElementById(
                    `edit-output-type-${id}`
                ).value;
                try {
                    JSON.parse(expected_output);
                } catch {
                    AppUtils.showAppMessage("Expected output must be valid JSON", "error");
                    return;
                }

                try {
                    const res = await fetch(`/api/test-cases/${id}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ input, expected_output, expected_output_type }),
                    });
                    if (res.ok) {
                        AppUtils.showAppMessage("Test case updated!", "success");
                        editingTestCaseId = null;
                        loadTestCases();
                    } else {
                        const error = await res.json();
                        AppUtils.showAppMessage(
                            error.error || "Failed to update test case",
                            "error"
                        );
                    }
                } catch (error) {
                    AppUtils.showAppMessage("Error updating test case", "error");
                }
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            function formatJSON(json) {
                try {
                    return escapeHtml(JSON.stringify(JSON.parse(json), null, 2));
                } catch {
                    return escapeHtml(json);
                }
            }

            function formatOutputType(type) {
                if (!type || typeof type !== "string") return "Array";
                // Handle case where type might be the literal string "Expected_output_type" or similar
                const normalized = type.toLowerCase();
                if (normalized === "string" || normalized === "array" || normalized === "object") {
                    return type.charAt(0).toUpperCase() + type.slice(1);
                }
                // If it's not a valid type, return default
                return "Array";
            }

            async function deleteTestCase(id) {
                if (!confirm("Are you sure you want to delete this test case?")) return;
                try {
                    const res = await fetch(`/api/test-cases/${id}`, { method: "DELETE" });
                    if (res.ok) {
                        AppUtils.showAppMessage("Test case deleted", "success");
                        loadTestCases();
                    } else {
                        AppUtils.showAppMessage("Failed to delete test case", "error");
                    }
                } catch (error) {
                    AppUtils.showAppMessage("Error deleting test case", "error");
                }
            }

            // Add Test Case Modal functions
            function openAddTestCaseModal() {
                const overlay = document.getElementById("add-test-case-modal");
                if (overlay) {
                    overlay.classList.add("active");
                    document.getElementById("input")?.focus();
                }
            }

            function closeAddTestCaseModal() {
                const overlay = document.getElementById("add-test-case-modal");
                if (overlay) {
                    overlay.classList.remove("active");
                    document.getElementById("test-case-form")?.reset();
                }
            }

            // Add Test Case button click handler
            document
                .getElementById("add-test-case-btn")
                .addEventListener("click", openAddTestCaseModal);

            // Close modal when clicking overlay
            document.getElementById("add-test-case-modal").addEventListener("click", (e) => {
                if (e.target === e.currentTarget) closeAddTestCaseModal();
            });

            // Close button handler
            document
                .getElementById("add-test-case-close-btn")
                .addEventListener("click", closeAddTestCaseModal);

            // Close modal on Escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    closeAddTestCaseModal();
                }
            });

            document.getElementById("test-case-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                if (!selectedPromptId) {
                    AppUtils.showAppMessage("Please select a prompt first", "error");
                    return;
                }

                const input = document.getElementById("input").value.trim();
                const expected_output = document.getElementById("expected_output").value.trim();
                const expected_output_type = document.getElementById("expected_output_type").value;
                try {
                    JSON.parse(expected_output);
                } catch {
                    AppUtils.showAppMessage("Expected output must be valid JSON", "error");
                    return;
                }

                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/test-cases`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ input, expected_output, expected_output_type }),
                    });
                    if (res.ok) {
                        AppUtils.showAppMessage("Test case added!", "success");
                        closeAddTestCaseModal();
                        loadTestCases();
                    } else {
                        const error = await res.json();
                        AppUtils.showAppMessage(error.error || "Failed to add test case", "error");
                    }
                } catch (error) {
                    AppUtils.showAppMessage("Error adding test case", "error");
                }
            });

            // Export and Import functions
            async function exportTestCases() {
                if (!selectedPromptId || !selectedPromptName) {
                    AppUtils.showAppMessage("Please select a prompt first", "error");
                    return;
                }

                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/test-cases/export`);
                    if (!res.ok) {
                        const error = await res.json();
                        AppUtils.showAppMessage(
                            error.error || "Failed to export test cases",
                            "error"
                        );
                        return;
                    }

                    const data = await res.json();
                    const jsonStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `test-cases-${selectedPromptName.replace(/[^a-z0-9]/gi, "_")}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    AppUtils.showAppMessage(
                        `Exported ${data.length} test case${data.length !== 1 ? "s" : ""}`,
                        "success"
                    );
                } catch (error) {
                    AppUtils.showAppMessage("Error exporting test cases", "error");
                }
            }

            async function importTestCases() {
                if (!selectedPromptId) {
                    AppUtils.showAppMessage("Please select a prompt first", "error");
                    return;
                }

                const input = document.createElement("input");
                input.type = "file";
                input.accept = "application/json";
                input.onchange = async (e) => {
                    const fileInput = e.target;
                    const file =
                        fileInput && fileInput.files && fileInput.files[0]
                            ? fileInput.files[0]
                            : null;
                    if (!file) return;

                    try {
                        const text = await file.text();
                        let testCasesData;

                        try {
                            testCasesData = JSON.parse(text);
                        } catch {
                            AppUtils.showAppMessage("Invalid JSON file", "error");
                            return;
                        }

                        if (!Array.isArray(testCasesData)) {
                            AppUtils.showAppMessage("JSON must be an array of test cases", "error");
                            return;
                        }

                        // Validate structure
                        for (let i = 0; i < testCasesData.length; i++) {
                            const tc = testCasesData[i];
                            if (!tc.input || !tc.expected_output || !tc.expected_output_type) {
                                AppUtils.showAppMessage(
                                    `Test case ${i + 1} is missing required fields (input, expected_output, expected_output_type)`,
                                    "error"
                                );
                                return;
                            }
                            try {
                                JSON.parse(tc.expected_output);
                            } catch {
                                AppUtils.showAppMessage(
                                    `Test case ${i + 1} has invalid JSON in expected_output`,
                                    "error"
                                );
                                return;
                            }
                        }

                        const count = testCasesData.length;
                        const confirmMessage =
                            count === 0
                                ? "This will delete all existing test cases. Continue?"
                                : `This will replace all existing test cases with ${count} new test case${count !== 1 ? "s" : ""}. Continue?`;

                        if (!confirm(confirmMessage)) return;

                        const res = await fetch(
                            `/api/prompts/${selectedPromptId}/test-cases/import`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(testCasesData),
                            }
                        );

                        if (res.ok) {
                            const result = await res.json();
                            AppUtils.showAppMessage(
                                `Successfully imported ${result.count} test case${result.count !== 1 ? "s" : ""}`,
                                "success"
                            );
                            loadTestCases();
                        } else {
                            const error = await res.json();
                            AppUtils.showAppMessage(
                                error.error || "Failed to import test cases",
                                "error"
                            );
                        }
                    } catch (error) {
                        AppUtils.showAppMessage("Error reading file", "error");
                    }
                };
                input.click();
            }

            // Export and Import button handlers
            document
                .getElementById("export-test-cases-btn")
                ?.addEventListener("click", exportTestCases);
            document
                .getElementById("import-test-cases-btn")
                ?.addEventListener("click", importTestCases);

            // Initialize
            updateUI();
        </script>
    </body>
</html>
