<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test Cases - Relia Prompt</title>
        <link rel="stylesheet" href="/styles.css" />
    </head>
    <body>
        <div class="app-layout app-shell" data-page="test-cases">
            <!-- Rail -->
            <aside class="app-rail" aria-label="Primary">
                <a class="app-rail-brand" href="/test-cases.html" aria-label="Relia Prompt Home">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        aria-hidden="true"
                    >
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                </a>
                <nav class="app-rail-nav" aria-label="Sections">
                    <a class="rail-link active" href="/test-cases.html" aria-current="page">
                        <span class="rail-link-label">Test Cases</span>
                    </a>
                    <a class="rail-link" href="/test-runs.html">
                        <span class="rail-link-label">Test Runs</span>
                    </a>
                    <a class="rail-link" href="/improve.html">
                        <span class="rail-link-label">Auto-Improve</span>
                    </a>
                </nav>
                <div class="app-rail-footer">
                    <button class="rail-btn" id="setup-btn" title="LLMs">LLMs</button>
                </div>
            </aside>

            <!-- Prompts Pane -->
            <aside class="app-pane app-pane-prompts" aria-label="Prompts">
                <div class="pane-header">
                    <div class="pane-title">Prompts</div>
                    <button class="btn btn-primary btn-sm" id="new-prompt-btn">New</button>
                </div>
                <div class="pane-search">
                    <input
                        id="prompt-filter"
                        type="search"
                        placeholder="Search prompts‚Ä¶"
                        autocomplete="off"
                    />
                    <div class="pane-search-hint">‚åòK</div>
                </div>
                <div class="pane-body">
                    <div class="sidebar-list" id="sidebar-prompts">
                        <div class="sidebar-empty">Loading...</div>
                    </div>
                </div>
            </aside>

            <!-- Content Pane -->
            <main class="app-pane app-pane-content" aria-label="Content">
                <header class="content-header">
                    <div class="content-header-main">
                        <h1 class="content-title">Test Cases</h1>
                        <p class="content-subtitle">
                            Define inputs and expected JSON outputs. Edit fast with the split view.
                        </p>
                    </div>
                    <div class="content-actions">
                        <button
                            id="export-test-cases-btn"
                            class="btn btn-secondary btn-sm"
                            disabled
                        >
                            Export
                        </button>
                        <button
                            id="import-test-cases-btn"
                            class="btn btn-secondary btn-sm"
                            disabled
                        >
                            Import
                        </button>
                        <button id="add-test-case-btn" class="btn btn-sm" disabled>
                            New test case
                        </button>
                    </div>
                </header>

                <div id="app-message"></div>

                <div class="content-body">
                    <!-- No Prompt Selected State -->
                    <div id="no-prompt-message" class="empty-state">
                        <div class="empty-state-icon" aria-hidden="true">üóÇ</div>
                        <h3>Select a prompt</h3>
                        <p>
                            Pick a prompt on the left to view and edit its test cases. Test cases
                            are shared across all versions.
                        </p>
                    </div>

                    <!-- Test Case Section (shown when prompt selected) -->
                    <div id="test-case-section" class="hidden">
                        <div class="split-view">
                            <section
                                class="split-pane split-pane-list"
                                aria-label="Test cases list"
                            >
                                <div class="split-pane-header">
                                    <div class="split-pane-title">
                                        Test cases
                                        <span id="test-cases-count" class="pill">0</span>
                                    </div>
                                    <input
                                        id="test-case-filter"
                                        type="search"
                                        placeholder="Filter test cases‚Ä¶"
                                        autocomplete="off"
                                    />
                                </div>
                                <div id="test-cases-list" class="tc-list">
                                    <div class="muted">Loading‚Ä¶</div>
                                </div>
                            </section>

                            <section
                                class="split-pane split-pane-detail"
                                aria-label="Test case editor"
                            >
                                <div
                                    id="testcase-editor-empty"
                                    class="empty-state empty-state-compact"
                                >
                                    <div class="empty-state-icon" aria-hidden="true">‚úçÔ∏è</div>
                                    <h3>Pick a test case</h3>
                                    <p>Select one on the left, or create a new one.</p>
                                </div>

                                <form id="testcase-editor" class="editor-card hidden">
                                    <div class="editor-header">
                                        <div>
                                            <div id="editor-title" class="editor-title">
                                                Test case
                                            </div>
                                            <div id="editor-subtitle" class="editor-subtitle"></div>
                                        </div>
                                        <div class="editor-header-actions">
                                            <button
                                                id="testcase-delete-btn"
                                                type="button"
                                                class="btn btn-danger btn-sm hidden"
                                            >
                                                Delete
                                            </button>
                                        </div>
                                    </div>

                                    <div class="editor-body">
                                        <div class="form-group">
                                            <label for="tc-input">Input (user message)</label>
                                            <textarea
                                                id="tc-input"
                                                name="input"
                                                placeholder="What will you send to the LLM?"
                                            ></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="tc-expected-output"
                                                >Expected output (JSON)</label
                                            >
                                            <textarea
                                                id="tc-expected-output"
                                                name="expected_output"
                                                class="tall"
                                                placeholder='[{"type":"company","name":"Microsoft"}]'
                                            ></textarea>
                                            <small
                                                >Must be valid JSON. We compare structure +
                                                values.</small
                                            >
                                        </div>
                                        <div class="form-group">
                                            <label for="tc-expected-output-type"
                                                >Expected output type</label
                                            >
                                            <select
                                                id="tc-expected-output-type"
                                                name="expected_output_type"
                                            >
                                                <option value="string">String</option>
                                                <option value="array" selected>Array</option>
                                                <option value="object">Object</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="editor-footer">
                                        <div class="editor-footer-left">
                                            <div
                                                id="tc-validation"
                                                class="inline-message hidden"
                                            ></div>
                                        </div>
                                        <div class="editor-footer-right">
                                            <button
                                                id="testcase-cancel-btn"
                                                type="button"
                                                class="btn btn-secondary btn-sm"
                                            >
                                                Cancel
                                            </button>
                                            <button
                                                id="testcase-save-btn"
                                                type="submit"
                                                class="btn btn-sm"
                                            >
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </section>
                        </div>

                        <div id="shared-test-cases-note" class="helper-note hidden">
                            Test cases are shared across all versions of this prompt.
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Config Modal -->
        <div class="modal-overlay" id="config-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>LLM Configuration</h2>
                    <button class="modal-close" id="config-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="config-form">
                    <div id="config-message"></div>
                    <div class="modal-body">
                        <div class="provider-section">
                            <h3>
                                OpenAI
                                <span id="openai-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="openai_api_key"
                                    name="openai_api_key"
                                    placeholder="API Key (sk-...)"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                AWS Bedrock
                                <span id="bedrock-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_access_key_id"
                                    name="bedrock_access_key_id"
                                    placeholder="Access Key ID (AKIA...)"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_secret_access_key"
                                    name="bedrock_secret_access_key"
                                    placeholder="Secret Access Key"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_region"
                                    name="bedrock_region"
                                    placeholder="Region (e.g., ap-southeast-2)"
                                    value="ap-southeast-2"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Deepseek
                                <span id="deepseek-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="deepseek_api_key"
                                    name="deepseek_api_key"
                                    placeholder="API Key (sk-...)"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Gemini
                                <span id="gemini-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="gemini_api_key"
                                    name="gemini_api_key"
                                    placeholder="API Key"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Groq
                                <span id="groq-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="groq_api_key"
                                    name="groq_api_key"
                                    placeholder="API Key (gsk_...)"
                                />
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                OpenRouter
                                <span id="openrouter-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="openrouter_api_key"
                                    name="openrouter_api_key"
                                    placeholder="API Key (sk-or-v1-...)"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeConfigModal()">
                            Cancel
                        </button>
                        <button type="submit">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New Prompt Modal -->
        <div class="modal-overlay" id="new-prompt-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>Create New Prompt</h2>
                    <button class="modal-close" id="new-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="new-prompt-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new-prompt-name">Prompt Name</label>
                            <input
                                type="text"
                                id="new-prompt-name"
                                name="name"
                                placeholder="e.g., extract-entities"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="new-prompt-content">Prompt Content</label>
                            <textarea
                                id="new-prompt-content"
                                name="content"
                                class="tall"
                                placeholder="Enter your system prompt here..."
                                required
                            ></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeNewPromptModal()">
                            Cancel
                        </button>
                        <button type="submit">Create Prompt</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Prompt Modal -->
        <div class="modal-overlay" id="edit-prompt-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>
                        Edit "<span id="edit-prompt-name-display"></span>"
                        <span id="edit-prompt-version" class="badge badge-version"></span>
                    </h2>
                    <button class="modal-close" id="edit-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="edit-prompt-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="edit-prompt-content">Prompt Content</label>
                            <textarea
                                id="edit-prompt-content"
                                name="content"
                                class="tall"
                                placeholder="Enter your system prompt here..."
                                required
                            ></textarea>
                            <small>Saving will create a new version of this prompt</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeEditPromptModal()">
                            Cancel
                        </button>
                        <button type="submit">Save as New Version</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Prompt Modal -->
        <div class="modal-overlay" id="view-prompt-modal">
            <div class="modal modal-wide">
                <div class="modal-header">
                    <div class="modal-title-group">
                        <h2 id="view-prompt-name-display">Prompt</h2>
                        <span class="badge badge-version" id="view-prompt-version">v1</span>
                    </div>
                    <button class="modal-close" id="view-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <pre class="view-prompt-content" id="view-prompt-content"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary" onclick="closeViewPromptModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <script src="/app.js"></script>
        <script>
            let selectedPromptId = null;
            let selectedPromptName = null;
            let activeTestCaseId = null;
            let editorMode = "none"; // none | create | edit
            let testCasesData = [];
            let testCaseFilterQuery = "";

            // Listen for prompt selection from sidebar
            window.addEventListener("promptSelected", (e) => {
                selectedPromptId = e.detail.id;
                selectedPromptName = e.detail.name;
                activeTestCaseId = null;
                editorMode = "none";
                updateUI();
                loadTestCases();
            });

            // Check for initial selection
            window.addEventListener("promptsLoaded", (e) => {
                const { prompts, selectedId } = e.detail;
                if (selectedId) {
                    const prompt = prompts.find((p) => p.id === selectedId);
                    if (prompt) {
                        selectedPromptId = prompt.id;
                        selectedPromptName = prompt.name;
                        updateUI();
                        loadTestCases();
                    } else {
                        // Stored selection no longer exists, clear it
                        AppUtils.setSelectedPromptId(null);
                        updateUI();
                    }
                } else {
                    // No selection stored, ensure "Select a Prompt" UI is shown
                    updateUI();
                }
            });

            function updateUI() {
                const hasSelection = !!selectedPromptId;
                document
                    .getElementById("test-case-section")
                    .classList.toggle("hidden", !hasSelection);
                document
                    .getElementById("no-prompt-message")
                    .classList.toggle("hidden", hasSelection);
                document.getElementById("add-test-case-btn").disabled = !hasSelection;
                document.getElementById("export-test-cases-btn").disabled = !hasSelection;
                document.getElementById("import-test-cases-btn").disabled = !hasSelection;
                document
                    .getElementById("shared-test-cases-note")
                    .classList.toggle("hidden", !hasSelection);

                if (!hasSelection) {
                    hideEditor();
                }
            }

            async function loadTestCases() {
                if (!selectedPromptId) return;
                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/test-cases`);
                    testCasesData = await res.json();
                    renderTestCasesList();
                } catch (error) {
                    document.getElementById("test-cases-list").innerHTML =
                        '<div class="inline-message error">Error loading test cases</div>';
                }
            }

            function normalizeOutputType(type) {
                if (!type || typeof type !== "string") return "array";
                const normalized = type.toLowerCase();
                if (normalized === "string" || normalized === "array" || normalized === "object") {
                    return normalized;
                }
                return "array";
            }

            function getTcOutputType(tc) {
                return normalizeOutputType(tc.expectedOutputType || tc.expected_output_type);
            }

            function getTcExpectedOutput(tc) {
                return tc.expectedOutput ?? tc.expected_output ?? "";
            }

            function getTcInput(tc) {
                return tc.input ?? "";
            }

            function renderTestCasesList() {
                const container = document.getElementById("test-cases-list");
                const countEl = document.getElementById("test-cases-count");

                const q = (testCaseFilterQuery || "").trim().toLowerCase();
                const filtered = q
                    ? testCasesData.filter((tc) => {
                          const input = getTcInput(tc).toLowerCase();
                          const expected = getTcExpectedOutput(tc).toLowerCase();
                          return input.includes(q) || expected.includes(q);
                      })
                    : testCasesData;

                countEl.textContent = String(filtered.length);

                if (testCasesData.length === 0) {
                    container.innerHTML =
                        '<div class="empty-state empty-state-compact"><div class="empty-state-icon" aria-hidden="true">üß™</div><h3>No test cases yet</h3><p>Create one to start testing this prompt.</p></div>';
                    return;
                }

                if (filtered.length === 0) {
                    container.innerHTML =
                        '<div class="empty-state empty-state-compact"><div class="empty-state-icon" aria-hidden="true">üîé</div><h3>No matches</h3><p>Try a different filter.</p></div>';
                    return;
                }

                container.innerHTML = filtered
                    .map((tc, idx) => {
                        const id = tc.id;
                        const input = getTcInput(tc);
                        const type = getTcOutputType(tc);
                        const isActive = id === activeTestCaseId;
                        const inputPreview = input.replace(/\s+/g, " ").slice(0, 120);

                        return `
                            <button class="tc-list-item ${isActive ? "active" : ""}" data-id="${id}" type="button">
                                <div class="tc-list-item-top">
                                    <div class="tc-list-item-title">#${idx + 1}</div>
                                    <span class="pill pill-muted">${type}</span>
                                </div>
                                <div class="tc-list-item-preview">${escapeHtml(inputPreview || "(empty input)")}</div>
                            </button>
                        `;
                    })
                    .join("");

                // Keep active item visible if possible
                if (activeTestCaseId) {
                    const activeBtn = container.querySelector(
                        `.tc-list-item[data-id="${activeTestCaseId}"]`
                    );
                    activeBtn?.scrollIntoView({ block: "nearest" });
                }
            }

            function showEditor(mode, tc) {
                const editor = document.getElementById("testcase-editor");
                const empty = document.getElementById("testcase-editor-empty");
                const deleteBtn = document.getElementById("testcase-delete-btn");
                const titleEl = document.getElementById("editor-title");
                const subtitleEl = document.getElementById("editor-subtitle");

                editorMode = mode;
                editor.classList.remove("hidden");
                empty.classList.add("hidden");
                clearEditorMessage();

                const isEdit = mode === "edit";
                deleteBtn.classList.toggle("hidden", !isEdit);
                titleEl.textContent = isEdit ? "Edit test case" : "New test case";
                subtitleEl.textContent = selectedPromptName ? `Prompt: ${selectedPromptName}` : "";

                if (tc) {
                    document.getElementById("tc-input").value = getTcInput(tc);
                    document.getElementById("tc-expected-output").value = getTcExpectedOutput(tc);
                    document.getElementById("tc-expected-output-type").value = getTcOutputType(tc);
                } else {
                    document.getElementById("tc-input").value = "";
                    document.getElementById("tc-expected-output").value = "";
                    document.getElementById("tc-expected-output-type").value = "array";
                }

                // Focus first field for speed
                document.getElementById("tc-input")?.focus();
            }

            function hideEditor() {
                const editor = document.getElementById("testcase-editor");
                const empty = document.getElementById("testcase-editor-empty");
                editor.classList.add("hidden");
                empty.classList.remove("hidden");
                editorMode = "none";
                activeTestCaseId = null;
                clearEditorMessage();
            }

            function showEditorMessage(text, type) {
                const el = document.getElementById("tc-validation");
                el.className = `inline-message ${type}`;
                el.textContent = text;
                el.classList.remove("hidden");
            }

            function clearEditorMessage() {
                const el = document.getElementById("tc-validation");
                el.textContent = "";
                el.classList.add("hidden");
                el.className = "inline-message hidden";
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text ?? "";
                return div.innerHTML;
            }

            function openNewTestCase() {
                if (!selectedPromptId) return;
                activeTestCaseId = null;
                showEditor("create", null);
            }

            function openExistingTestCase(id) {
                const tc = testCasesData.find((t) => t.id === id);
                if (!tc) return;
                activeTestCaseId = id;
                showEditor("edit", tc);
                renderTestCasesList();
            }

            async function saveEditor() {
                if (!selectedPromptId) return;

                const input = document.getElementById("tc-input").value.trim();
                const expected_output = document.getElementById("tc-expected-output").value.trim();
                const expected_output_type =
                    document.getElementById("tc-expected-output-type").value;

                if (!input) {
                    showEditorMessage("Input is required.", "error");
                    return;
                }
                if (!expected_output) {
                    showEditorMessage("Expected output is required.", "error");
                    return;
                }
                try {
                    JSON.parse(expected_output);
                } catch {
                    showEditorMessage("Expected output must be valid JSON.", "error");
                    return;
                }

                const isEdit = editorMode === "edit" && !!activeTestCaseId;

                try {
                    const url = isEdit
                        ? `/api/test-cases/${activeTestCaseId}`
                        : `/api/prompts/${selectedPromptId}/test-cases`;
                    const method = isEdit ? "PUT" : "POST";
                    const res = await fetch(url, {
                        method,
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ input, expected_output, expected_output_type }),
                    });

                    if (!res.ok) {
                        const error = await res.json().catch(() => ({}));
                        throw new Error(error.error || "Failed to save test case");
                    }

                    const createdOrUpdated = await res.json().catch(() => null);
                    await loadTestCases();

                    if (createdOrUpdated && createdOrUpdated.id) {
                        activeTestCaseId = createdOrUpdated.id;
                    }

                    AppUtils.showAppMessage(
                        isEdit ? "Test case updated" : "Test case created",
                        "success"
                    );
                    if (activeTestCaseId) {
                        openExistingTestCase(activeTestCaseId);
                    } else {
                        hideEditor();
                    }
                } catch (error) {
                    showEditorMessage(error.message || "Error saving test case.", "error");
                }
            }

            async function deleteActiveTestCase() {
                if (!activeTestCaseId) return;
                if (!confirm("Delete this test case? This cannot be undone.")) return;
                try {
                    const res = await fetch(`/api/test-cases/${activeTestCaseId}`, {
                        method: "DELETE",
                    });
                    if (!res.ok) {
                        const error = await res.json().catch(() => ({}));
                        throw new Error(error.error || "Failed to delete test case");
                    }
                    AppUtils.showAppMessage("Test case deleted", "success");
                    activeTestCaseId = null;
                    hideEditor();
                    await loadTestCases();
                } catch (error) {
                    showEditorMessage(error.message || "Error deleting test case.", "error");
                }
            }

            // List interactions
            document.getElementById("test-cases-list").addEventListener("click", (e) => {
                const btn = e.target.closest(".tc-list-item");
                if (!btn) return;
                const id = parseInt(btn.dataset.id, 10);
                if (!Number.isFinite(id)) return;
                openExistingTestCase(id);
            });

            // Filters + actions
            document.getElementById("test-case-filter").addEventListener("input", (e) => {
                testCaseFilterQuery = e.target.value || "";
                renderTestCasesList();
            });

            document.getElementById("add-test-case-btn").addEventListener("click", openNewTestCase);

            document.getElementById("testcase-cancel-btn").addEventListener("click", () => {
                if (activeTestCaseId) {
                    openExistingTestCase(activeTestCaseId);
                } else {
                    hideEditor();
                }
            });

            document
                .getElementById("testcase-delete-btn")
                .addEventListener("click", deleteActiveTestCase);

            document.getElementById("testcase-editor").addEventListener("submit", async (e) => {
                e.preventDefault();
                await saveEditor();
            });

            // Export and Import functions
            async function exportTestCases() {
                if (!selectedPromptId || !selectedPromptName) {
                    AppUtils.showAppMessage("Please select a prompt first", "error");
                    return;
                }

                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/test-cases/export`);
                    if (!res.ok) {
                        const error = await res.json();
                        AppUtils.showAppMessage(
                            error.error || "Failed to export test cases",
                            "error"
                        );
                        return;
                    }

                    const data = await res.json();
                    const jsonStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonStr], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `test-cases-${selectedPromptName.replace(/[^a-z0-9]/gi, "_")}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    AppUtils.showAppMessage(
                        `Exported ${data.length} test case${data.length !== 1 ? "s" : ""}`,
                        "success"
                    );
                } catch (error) {
                    AppUtils.showAppMessage("Error exporting test cases", "error");
                }
            }

            async function importTestCases() {
                if (!selectedPromptId) {
                    AppUtils.showAppMessage("Please select a prompt first", "error");
                    return;
                }

                const input = document.createElement("input");
                input.type = "file";
                input.accept = "application/json";
                input.onchange = async (e) => {
                    const fileInput = e.target;
                    const file =
                        fileInput && fileInput.files && fileInput.files[0]
                            ? fileInput.files[0]
                            : null;
                    if (!file) return;

                    try {
                        const text = await file.text();
                        let testCasesData;

                        try {
                            testCasesData = JSON.parse(text);
                        } catch {
                            AppUtils.showAppMessage("Invalid JSON file", "error");
                            return;
                        }

                        if (!Array.isArray(testCasesData)) {
                            AppUtils.showAppMessage("JSON must be an array of test cases", "error");
                            return;
                        }

                        // Validate structure
                        for (let i = 0; i < testCasesData.length; i++) {
                            const tc = testCasesData[i];
                            if (!tc.input || !tc.expected_output || !tc.expected_output_type) {
                                AppUtils.showAppMessage(
                                    `Test case ${i + 1} is missing required fields (input, expected_output, expected_output_type)`,
                                    "error"
                                );
                                return;
                            }
                            try {
                                JSON.parse(tc.expected_output);
                            } catch {
                                AppUtils.showAppMessage(
                                    `Test case ${i + 1} has invalid JSON in expected_output`,
                                    "error"
                                );
                                return;
                            }
                        }

                        const count = testCasesData.length;
                        const confirmMessage =
                            count === 0
                                ? "This will delete all existing test cases. Continue?"
                                : `This will replace all existing test cases with ${count} new test case${count !== 1 ? "s" : ""}. Continue?`;

                        if (!confirm(confirmMessage)) return;

                        const res = await fetch(
                            `/api/prompts/${selectedPromptId}/test-cases/import`,
                            {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify(testCasesData),
                            }
                        );

                        if (res.ok) {
                            const result = await res.json();
                            AppUtils.showAppMessage(
                                `Successfully imported ${result.count} test case${result.count !== 1 ? "s" : ""}`,
                                "success"
                            );
                            loadTestCases();
                        } else {
                            const error = await res.json();
                            AppUtils.showAppMessage(
                                error.error || "Failed to import test cases",
                                "error"
                            );
                        }
                    } catch (error) {
                        AppUtils.showAppMessage("Error reading file", "error");
                    }
                };
                input.click();
            }

            // Export and Import button handlers
            document
                .getElementById("export-test-cases-btn")
                ?.addEventListener("click", exportTestCases);
            document
                .getElementById("import-test-cases-btn")
                ?.addEventListener("click", importTestCases);

            // Prompt filter (global prompt pane)
            document.getElementById("prompt-filter")?.addEventListener("input", (e) => {
                // handled by app.js when present; keep no-op safe here
            });

            // Initialize
            updateUI();
        </script>
    </body>
</html>
