<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Test Runs - Relia Prompt</title>
        <link rel="stylesheet" href="/styles.css" />
    </head>
    <body>
        <div class="app-layout app-shell" data-page="test-runs">
            <!-- Rail -->
            <aside class="app-rail" aria-label="Primary">
                <a class="app-rail-brand" href="/test-cases.html" aria-label="Relia Prompt Home">
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        aria-hidden="true"
                    >
                        <path d="M12 2L2 7l10 5 10-5-10-5z" />
                        <path d="M2 17l10 5 10-5" />
                        <path d="M2 12l10 5 10-5" />
                    </svg>
                </a>
                <nav class="app-rail-nav" aria-label="Sections">
                    <a class="rail-link" href="/test-cases.html">
                        <span class="rail-link-label">Test Cases</span>
                    </a>
                    <a class="rail-link active" href="/test-runs.html" aria-current="page">
                        <span class="rail-link-label">Test Runs</span>
                    </a>
                    <a class="rail-link" href="/improve.html">
                        <span class="rail-link-label">Auto-Improve</span>
                    </a>
                </nav>
                <div class="app-rail-footer">
                    <button class="rail-btn" id="setup-btn" title="LLMs">LLMs</button>
                </div>
            </aside>

            <!-- Prompts Pane -->
            <aside class="app-pane app-pane-prompts" aria-label="Prompts">
                <div class="pane-header">
                    <div class="pane-title">Prompts</div>
                    <button class="btn btn-primary btn-sm" id="new-prompt-btn">New</button>
                </div>
                <div class="pane-search">
                    <input
                        id="prompt-filter"
                        type="search"
                        placeholder="Search prompts‚Ä¶"
                        autocomplete="off"
                    />
                    <div class="pane-search-hint">‚åòK</div>
                </div>
                <div class="pane-body">
                    <div class="sidebar-list" id="sidebar-prompts">
                        <div class="sidebar-empty">Loading...</div>
                    </div>
                </div>
            </aside>

            <!-- Content Pane -->
            <main class="app-pane app-pane-content" aria-label="Content">
                <header class="content-header">
                    <div class="content-header-main">
                        <h1 class="content-title">Test Runs</h1>
                        <p class="content-subtitle">
                            Run your prompt against selected models and inspect results.
                        </p>
                    </div>
                </header>

                <div id="app-message"></div>

                <div class="content-body">
                    <!-- No Prompt Selected State -->
                    <div id="no-prompt-message" class="empty-state">
                        <div class="empty-state-icon" aria-hidden="true">üöÄ</div>
                        <h3>Select a prompt</h3>
                        <p>Pick a prompt on the left to run tests and compare LLM outputs.</p>
                    </div>

                    <!-- Test Section (shown when prompt selected) -->
                    <div id="test-section" class="hidden">
                        <div class="content-grid">
                            <section class="content-col">
                                <div class="card">
                                    <div class="card-header">
                                        <h2>
                                            Run tests for "<span id="selected-prompt-name"></span>"
                                        </h2>
                                    </div>

                                    <div id="test-case-count" class="muted mb-20"></div>
                                    <div class="helper-note mb-20">
                                        Test cases are shared across all versions of this prompt.
                                    </div>

                                    <div class="runs-config mb-20">
                                        <label for="runs-per-test">Runs per test case</label>
                                        <div class="range-row">
                                            <input
                                                type="range"
                                                id="runs-per-test"
                                                min="1"
                                                max="10"
                                                value="1"
                                            />
                                            <span id="runs-per-test-value" class="range-value"
                                                >1</span
                                            >
                                        </div>
                                        <small
                                            >More runs = more reliable results, but takes
                                            longer</small
                                        >
                                    </div>

                                    <div class="model-selection-section mb-20">
                                        <label>
                                            Models to test
                                            <span id="selected-models-count" class="muted"
                                                >(0 selected)</span
                                            >
                                        </label>
                                        <div
                                            id="test-models-selection"
                                            class="model-selection-container"
                                        >
                                            <div class="no-models">Loading models...</div>
                                        </div>
                                    </div>

                                    <button id="run-btn" disabled>Run Tests</button>

                                    <div id="progress-section" class="progress-section hidden">
                                        <div class="progress-label">Overall Progress</div>
                                        <div class="progress-bar-container">
                                            <div
                                                id="progress-bar"
                                                class="progress-bar"
                                                style="width: 0%"
                                            >
                                                0%
                                            </div>
                                        </div>
                                        <div
                                            id="progress-details"
                                            class="muted"
                                            style="font-size: 14px"
                                        ></div>
                                    </div>
                                </div>
                            </section>

                            <section class="content-col">
                                <div id="results-section" class="hidden">
                                    <div class="card">
                                        <h2>
                                            Results
                                            <span
                                                id="overall-score-badge"
                                                class="score-badge"
                                                data-tooltip="Overall"
                                            ></span>
                                            <span
                                                id="best-score-badge"
                                                class="score-badge best hidden"
                                                data-tooltip="Best LLM"
                                            ></span>
                                        </h2>
                                        <div id="llm-results" class="llm-results"></div>
                                    </div>
                                </div>

                                <div id="previous-runs-section" class="card">
                                    <h2>Previous Test Runs</h2>
                                    <div id="previous-runs-list">
                                        <div class="muted">Loading...</div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Config Modal -->
        <div class="modal-overlay" id="config-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>LLM Configuration</h2>
                    <button class="modal-close" id="config-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="config-form">
                    <div id="config-message"></div>
                    <div class="modal-body">
                        <div class="provider-section">
                            <h3>
                                OpenAI
                                <span id="openai-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="openai_api_key"
                                    name="openai_api_key"
                                    placeholder="API Key (sk-...)"
                                />
                            </div>
                            <div class="form-group">
                                <label>Models</label>
                                <div id="openai-models" class="model-selection-container">
                                    <div class="no-models">Configure API key to see models</div>
                                </div>
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                AWS Bedrock
                                <span id="bedrock-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_access_key_id"
                                    name="bedrock_access_key_id"
                                    placeholder="Access Key ID (AKIA...)"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_secret_access_key"
                                    name="bedrock_secret_access_key"
                                    placeholder="Secret Access Key"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_session_token"
                                    name="bedrock_session_token"
                                    placeholder="Session Token (optional)"
                                />
                            </div>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="bedrock_region"
                                    name="bedrock_region"
                                    placeholder="Region (e.g., ap-southeast-2)"
                                    value="ap-southeast-2"
                                />
                            </div>
                            <div class="form-group">
                                <label>Models</label>
                                <div id="bedrock-models" class="model-selection-container">
                                    <div class="no-models">Configure credentials to see models</div>
                                </div>
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Deepseek
                                <span id="deepseek-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="deepseek_api_key"
                                    name="deepseek_api_key"
                                    placeholder="API Key (sk-...)"
                                />
                            </div>
                            <div class="form-group">
                                <label>Models</label>
                                <div id="deepseek-models" class="model-selection-container">
                                    <div class="no-models">Configure API key to see models</div>
                                </div>
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Gemini
                                <span id="gemini-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="gemini_api_key"
                                    name="gemini_api_key"
                                    placeholder="API Key"
                                />
                            </div>
                            <div class="form-group">
                                <label>Models</label>
                                <div id="gemini-models" class="model-selection-container">
                                    <div class="no-models">Configure API key to see models</div>
                                </div>
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                Groq
                                <span id="groq-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="groq_api_key"
                                    name="groq_api_key"
                                    placeholder="API Key (gsk_...)"
                                />
                            </div>
                            <div class="form-group">
                                <label>Models</label>
                                <div id="groq-models" class="model-selection-container">
                                    <div class="no-models">Configure API key to see models</div>
                                </div>
                            </div>
                        </div>

                        <div class="provider-section">
                            <h3>
                                OpenRouter
                                <span id="openrouter-status" class="status-badge not-configured"
                                    >Not configured</span
                                >
                            </h3>
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="openrouter_api_key"
                                    name="openrouter_api_key"
                                    placeholder="API Key (sk-or-v1-...)"
                                />
                            </div>
                            <div class="form-group">
                                <label>Models</label>
                                <div id="openrouter-models" class="model-selection-container">
                                    <div class="no-models">Configure API key to see models</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeConfigModal()">
                            Cancel
                        </button>
                        <button type="submit">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- New Prompt Modal -->
        <div class="modal-overlay" id="new-prompt-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>Create New Prompt</h2>
                    <button class="modal-close" id="new-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="new-prompt-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new-prompt-name">Prompt Name</label>
                            <input
                                type="text"
                                id="new-prompt-name"
                                name="name"
                                placeholder="e.g., extract-entities"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <label for="new-prompt-content">Prompt Content</label>
                            <textarea
                                id="new-prompt-content"
                                name="content"
                                class="tall"
                                placeholder="Enter your system prompt here..."
                                required
                            ></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeNewPromptModal()">
                            Cancel
                        </button>
                        <button type="submit">Create Prompt</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Prompt Modal -->
        <div class="modal-overlay" id="edit-prompt-modal">
            <div class="modal">
                <div class="modal-header">
                    <h2>
                        Edit "<span id="edit-prompt-name-display"></span>"
                        <span id="edit-prompt-version" class="badge badge-version"></span>
                    </h2>
                    <button class="modal-close" id="edit-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <form id="edit-prompt-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="edit-prompt-content">Prompt Content</label>
                            <textarea
                                id="edit-prompt-content"
                                name="content"
                                class="tall"
                                placeholder="Enter your system prompt here..."
                                required
                            ></textarea>
                            <small>Saving will create a new version of this prompt</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="secondary" onclick="closeEditPromptModal()">
                            Cancel
                        </button>
                        <button type="submit">Save as New Version</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Prompt Modal -->
        <div class="modal-overlay" id="view-prompt-modal">
            <div class="modal modal-wide">
                <div class="modal-header">
                    <div class="modal-title-group">
                        <h2 id="view-prompt-name-display">Prompt</h2>
                        <span class="badge badge-version" id="view-prompt-version">v1</span>
                    </div>
                    <button class="modal-close" id="view-prompt-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div class="modal-body">
                    <pre class="view-prompt-content" id="view-prompt-content"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="secondary" onclick="closeViewPromptModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Details Modal -->
        <div class="modal-overlay" id="test-details-modal">
            <div class="modal modal-wide">
                <div class="modal-header">
                    <div class="modal-title-group">
                        <h2 id="test-details-llm-name">Test Details</h2>
                        <span class="score-badge" id="test-details-score-badge"></span>
                    </div>
                    <button class="modal-close" id="test-details-close-btn">
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                        >
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                        </svg>
                    </button>
                </div>
                <div
                    class="modal-body"
                    id="test-details-content"
                    style="max-height: 60vh; overflow-y: auto"
                ></div>
                <div class="modal-footer">
                    <button type="button" class="secondary" onclick="closeTestDetailsModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <script src="/app.js"></script>
        <script>
            let selectedPromptId = null;
            let selectedPromptName = null;
            let pollInterval = null;
            let storedLlmResults = {};

            // Listen for prompt selection from sidebar
            window.addEventListener("promptSelected", (e) => {
                selectedPromptId = e.detail.id;
                selectedPromptName = e.detail.name;
                updateUI();
                loadTestCaseCount();
                loadPreviousTestRuns();
                document.getElementById("results-section").classList.add("hidden");
                document.getElementById("progress-section").classList.add("hidden");
            });

            // Listen for model selection changes
            window.addEventListener("modelsSelectionChanged", (e) => {
                updateSelectedModelsCount();
                updateRunButtonState();
            });

            // Check for initial selection
            window.addEventListener("promptsLoaded", async (e) => {
                const { prompts, selectedId } = e.detail;
                if (selectedId) {
                    const prompt = prompts.find((p) => p.id === selectedId);
                    if (prompt) {
                        selectedPromptId = prompt.id;
                        selectedPromptName = prompt.name;
                        updateUI();
                        loadTestCaseCount();
                        loadPreviousTestRuns();
                    }
                }
                // Load models for the test run section
                await loadTestModels();
            });

            async function loadTestModels() {
                await AppUtils.loadAvailableModels();
                await AppUtils.loadSelectedModels();
                AppUtils.renderModelCheckboxes("test-models-selection");
                updateSelectedModelsCount();
                updateRunButtonState();
            }

            function updateSelectedModelsCount() {
                const count = AppUtils.getSelectedModelsCount();
                document.getElementById("selected-models-count").textContent =
                    `(${count} selected)`;
            }

            function updateRunButtonState() {
                const countEl = document.getElementById("test-case-count");
                const testCaseCount = countEl.dataset.count
                    ? parseInt(countEl.dataset.count, 10)
                    : 0;
                const modelCount = AppUtils.getSelectedModelsCount();
                document.getElementById("run-btn").disabled =
                    testCaseCount === 0 || modelCount === 0;
            }

            function updateUI() {
                const hasSelection = !!selectedPromptId;
                document.getElementById("test-section").classList.toggle("hidden", !hasSelection);
                document
                    .getElementById("no-prompt-message")
                    .classList.toggle("hidden", hasSelection);
                if (selectedPromptName) {
                    document.getElementById("selected-prompt-name").textContent =
                        selectedPromptName;
                }
            }

            function getRunsPerTest() {
                return parseInt(document.getElementById("runs-per-test").value, 10) || 10;
            }

            function updateRunsDisplay() {
                const runs = getRunsPerTest();
                document.getElementById("runs-per-test-value").textContent = runs;
                updateTestCaseCountText();
            }

            function updateTestCaseCountText() {
                const countEl = document.getElementById("test-case-count");
                if (!countEl.dataset.count) return;

                const count = parseInt(countEl.dataset.count, 10);
                const runs = getRunsPerTest();
                countEl.textContent =
                    count > 0
                        ? `${count} test case(s) will be run ${runs} time${runs !== 1 ? "s" : ""} each across all LLMs`
                        : "No test cases found. Add test cases first.";
            }

            async function loadTestCaseCount() {
                if (!selectedPromptId) {
                    document.getElementById("test-case-count").textContent = "";
                    document.getElementById("test-case-count").dataset.count = "";
                    updateRunButtonState();
                    return;
                }
                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/test-cases`);
                    const testCases = await res.json();
                    const count = testCases.length;
                    const runs = getRunsPerTest();
                    document.getElementById("test-case-count").dataset.count = count;
                    document.getElementById("test-case-count").textContent =
                        count > 0
                            ? `${count} test case(s) will be run ${runs} time${runs !== 1 ? "s" : ""} each across selected models`
                            : "No test cases found. Add test cases first.";
                    updateRunButtonState();
                } catch (error) {
                    document.getElementById("test-case-count").textContent =
                        "Error loading test cases";
                    document.getElementById("run-btn").disabled = true;
                }
            }

            async function loadPreviousTestRuns() {
                const container = document.getElementById("previous-runs-list");
                if (!selectedPromptId) {
                    container.innerHTML =
                        '<div style="color: var(--color-text-muted);">Select a prompt to see previous test runs</div>';
                    return;
                }

                try {
                    const res = await fetch(`/api/prompts/${selectedPromptId}/test-jobs`);
                    const jobs = await res.json();

                    if (jobs.length === 0) {
                        container.innerHTML =
                            '<div style="color: var(--color-text-muted);">No previous test runs for this prompt</div>';
                        return;
                    }

                    container.innerHTML = jobs
                        .map((job) => {
                            const date = new Date(job.createdAt);
                            const formattedDate =
                                date.toLocaleDateString() + " " + date.toLocaleTimeString();
                            const statusClass =
                                job.status === "completed"
                                    ? "success"
                                    : job.status === "failed"
                                      ? "failure"
                                      : "pending";
                            const statusText =
                                job.status.charAt(0).toUpperCase() + job.status.slice(1);

                            let scoreHtml = "";
                            if (job.status === "completed" && job.results) {
                                try {
                                    const results = JSON.parse(job.results);
                                    const overallScorePercent = AppUtils.scoreToPercent(
                                        results.overallScore
                                    );
                                    const overallBadgeClass =
                                        overallScorePercent >= 90
                                            ? ""
                                            : overallScorePercent >= 80
                                              ? "medium"
                                              : "low";
                                    const bestScore = getBestLLMScore(results.llmResults);

                                    scoreHtml = `<span class="score-badge ${overallBadgeClass}" data-tooltip="Overall">${overallScorePercent}%</span>`;
                                    if (bestScore !== null) {
                                        scoreHtml += `<span class="score-badge best" data-tooltip="Best LLM">${bestScore}%</span>`;
                                    }
                                } catch {}
                            }

                            return `
                            <div class="previous-run-item" data-job-id="${job.id}" onclick="viewPreviousRun('${job.id}')">
                                <div class="previous-run-info">
                                    <span class="previous-run-date">${escapeHtml(formattedDate)}</span>
                                    <span class="previous-run-tests">${job.totalTests} tests</span>
                                </div>
                                <div class="previous-run-status">
                                    ${scoreHtml}
                                    <span class="status-indicator ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        `;
                        })
                        .join("");
                } catch (error) {
                    container.innerHTML =
                        '<div style="color: var(--color-text-muted);">Error loading previous test runs</div>';
                }
            }

            async function viewPreviousRun(jobId) {
                try {
                    const res = await fetch(`/api/test/status/${jobId}`);
                    const status = await res.json();

                    if (status.results) {
                        showResults(status.results);
                        // Scroll to results
                        document
                            .getElementById("results-section")
                            .scrollIntoView({ behavior: "auto", block: "start" });
                    } else {
                        AppUtils.showAppMessage("No results available for this test run", "info");
                    }
                } catch (error) {
                    AppUtils.showAppMessage("Error loading test run results", "error");
                }
            }

            async function runTests() {
                if (!selectedPromptId) return;

                const selectedModels = AppUtils.getSelectedModels();
                if (selectedModels.length === 0) {
                    AppUtils.showAppMessage(
                        "Please select at least one model to run tests",
                        "error"
                    );
                    return;
                }

                document.getElementById("run-btn").disabled = true;
                document.getElementById("progress-section").classList.remove("hidden");
                document.getElementById("results-section").classList.add("hidden");
                AppUtils.showAppMessage("Starting test run...", "info");

                try {
                    const runsPerTest = getRunsPerTest();
                    const res = await fetch("/api/test/run", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            promptId: selectedPromptId,
                            runsPerTest,
                            selectedModels,
                        }),
                    });
                    if (!res.ok) {
                        const error = await res.json();
                        throw new Error(error.error || "Failed to start test run");
                    }
                    const { jobId } = await res.json();
                    pollProgress(jobId);
                } catch (error) {
                    AppUtils.showAppMessage(error.message, "error");
                    document.getElementById("run-btn").disabled = false;
                    document.getElementById("progress-section").classList.add("hidden");
                }
            }

            function pollProgress(jobId) {
                if (pollInterval) clearInterval(pollInterval);
                pollInterval = setInterval(async () => {
                    try {
                        const res = await fetch(`/api/test/status/${jobId}`);
                        const status = await res.json();
                        updateProgress(status);

                        if (status.status === "completed") {
                            clearInterval(pollInterval);
                            document.getElementById("run-btn").disabled = false;
                            document.getElementById("app-message").innerHTML = "";
                            showResults(status.results);
                            loadPreviousTestRuns(); // Refresh the list after completion
                        } else if (status.status === "failed") {
                            clearInterval(pollInterval);
                            document.getElementById("run-btn").disabled = false;
                            AppUtils.showAppMessage(status.error || "Test run failed", "error");
                            loadPreviousTestRuns(); // Refresh the list after failure too
                        }
                    } catch (error) {
                        AppUtils.showAppMessage("Error checking test status", "error");
                    }
                }, 1000);
            }

            function updateProgress(status) {
                const progress = status.progress || 0;
                document.getElementById("progress-bar").style.width = progress + "%";
                document.getElementById("progress-bar").textContent = progress + "%";
                document.getElementById("progress-details").textContent =
                    `${status.completedTests || 0} / ${status.totalTests || 0} tests completed`;
            }

            function getBestLLMScore(llmResults) {
                if (!llmResults || llmResults.length === 0) return null;
                const maxScore = Math.max(...llmResults.map((llm) => llm.score));
                return AppUtils.scoreToPercent(maxScore);
            }

            function showResults(results) {
                if (!results) return;
                document.getElementById("results-section").classList.remove("hidden");

                // Store results for modal access
                storedLlmResults = {};
                results.llmResults.forEach((llm) => {
                    storedLlmResults[llm.llmName] = llm;
                });

                // Get best LLM score
                const bestScore = getBestLLMScore(results.llmResults);
                const overallScorePercent = AppUtils.scoreToPercent(results.overallScore);

                // Set overall score badge next to Results heading
                const overallBadgeClass =
                    overallScorePercent >= 90 ? "" : overallScorePercent >= 80 ? "medium" : "low";
                const bestBadgeClass = bestScore >= 90 ? "" : bestScore >= 80 ? "medium" : "low";

                document.getElementById("overall-score-badge").className =
                    `score-badge ${overallBadgeClass}`;
                document.getElementById("overall-score-badge").textContent =
                    `${overallScorePercent}%`;
                document.getElementById("overall-score-badge").dataset.tooltip = "Overall";

                // Add best LLM score badge if we have multiple LLMs or just show it anyway
                const bestBadgeEl = document.getElementById("best-score-badge");
                if (bestScore !== null) {
                    bestBadgeEl.className = `score-badge best`;
                    bestBadgeEl.textContent = `${bestScore}%`;
                    bestBadgeEl.dataset.tooltip = "Best LLM";
                    bestBadgeEl.classList.remove("hidden");
                } else {
                    bestBadgeEl.classList.add("hidden");
                }

                document.getElementById("llm-results").innerHTML = results.llmResults
                    .map((llm) => {
                        const llmScorePercent = AppUtils.scoreToPercent(llm.score);
                        const badgeClass =
                            llmScorePercent >= 90 ? "" : llmScorePercent >= 80 ? "medium" : "low";
                        const avgDurationText = llm.durationStats
                            ? `<span class="duration-badge" title="Average response time">‚è± ${formatDuration(llm.durationStats.avgMs)}</span>`
                            : "";
                        return `
                        <div class="llm-result-row">
                            <span class="llm-result-name">${llm.llmName}</span>
                            <span class="score-badge ${badgeClass}">${llmScorePercent}% avg score</span>
                            ${avgDurationText}
                            <button class="btn-view-details" onclick="openTestDetailsModal('${llm.llmName}')" title="View details">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    })
                    .join("");
            }

            function formatDuration(ms) {
                if (ms < 1000) return `${ms}ms`;
                return `${(ms / 1000).toFixed(2)}s`;
            }

            let showAllRuns = false;

            function toggleShowAllRuns() {
                showAllRuns = !showAllRuns;
                const btn = document.getElementById("toggle-runs-btn");
                if (btn) {
                    btn.textContent = showAllRuns ? "Hide Individual Runs" : "Show Individual Runs";
                    btn.classList.toggle("active", showAllRuns);
                }
                // Re-render the current modal content
                const llmName = document.getElementById("test-details-llm-name").textContent;
                if (llmName && storedLlmResults[llmName]) {
                    renderTestDetailsContent(storedLlmResults[llmName]);
                }
            }

            function renderTestDetailsContent(llm) {
                // Build duration stats section if available
                let durationStatsHtml = "";
                if (llm.durationStats) {
                    durationStatsHtml = `
                        <div class="duration-stats-section" style="background: var(--color-bg-elevated); padding: 12px 16px; border-radius: 8px; margin-bottom: 16px;">
                            <strong style="display: block; margin-bottom: 8px;">‚è± Response Time Statistics</strong>
                            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
                                <div><span style="color: var(--color-text-muted);">Min:</span> <strong>${formatDuration(llm.durationStats.minMs)}</strong></div>
                                <div><span style="color: var(--color-text-muted);">Max:</span> <strong>${formatDuration(llm.durationStats.maxMs)}</strong></div>
                                <div><span style="color: var(--color-text-muted);">Average:</span> <strong>${formatDuration(llm.durationStats.avgMs)}</strong></div>
                            </div>
                        </div>
                    `;
                }

                // Toggle button
                const toggleBtnHtml = `
                    <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">
                        <button type="button" id="toggle-runs-btn" class="btn-toggle-runs ${showAllRuns ? "active" : ""}" onclick="toggleShowAllRuns()">
                            ${showAllRuns ? "Hide Individual Runs" : "Show Individual Runs"}
                        </button>
                    </div>
                `;

                document.getElementById("test-details-content").innerHTML =
                    durationStatsHtml +
                    toggleBtnHtml +
                    llm.testCaseResults
                        .map((tc, i) => {
                            const avgScore = AppUtils.scoreToPercent(tc.averageScore || 0);
                            const scoreClass =
                                avgScore >= 90 ? "" : avgScore >= 80 ? "medium" : "low";

                            // Individual runs section
                            let runsHtml = "";
                            if (showAllRuns && tc.runs && tc.runs.length > 0) {
                                runsHtml = `
                                <div class="individual-runs-section" style="margin-top: 12px; border-top: 1px solid var(--color-border); padding-top: 12px;">
                                    <div style="margin-bottom: 8px; font-weight: 600; color: var(--color-text-muted);">Individual Runs:</div>
                                    ${tc.runs
                                        .map((run, runIdx) => {
                                            const runScore = AppUtils.scoreToPercent(
                                                run.score || 0
                                            );
                                            const runScoreClass =
                                                runScore >= 90
                                                    ? "success"
                                                    : runScore >= 80
                                                      ? "medium"
                                                      : "failure";
                                            const runStatusIcon = run.isCorrect
                                                ? "‚úì"
                                                : runScore >= 80
                                                  ? "‚óê"
                                                  : "‚úó";
                                            const expectedFound = run.expectedFound || 0;
                                            const expectedTotal = run.expectedTotal || 0;
                                            const unexpectedFound = run.unexpectedFound || 0;

                                            // Build score breakdown text
                                            let scoreBreakdown = "";
                                            if (expectedTotal > 0 || unexpectedFound > 0) {
                                                scoreBreakdown = `<div style="font-size: 12px; color: var(--color-text-muted); margin-top: 4px;">
                                                <span style="color: var(--color-success);">${expectedFound}/${expectedTotal} expected found</span>
                                                ${unexpectedFound > 0 ? `<span style="color: var(--color-failure); margin-left: 8px;">+${unexpectedFound} unexpected</span>` : ""}
                                            </div>`;
                                            }

                                            const durationText =
                                                run.durationMs !== undefined
                                                    ? `<span class="duration-badge" style="font-size: 11px; opacity: 0.8;">‚è± ${formatDuration(run.durationMs)}</span>`
                                                    : "";
                                            return `
                                            <div class="individual-run" style="background: var(--color-bg-elevated); padding: 10px 12px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid var(--color-${runScoreClass});">
                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap;">
                                                    <span class="run-status-icon ${runScoreClass}" style="font-weight: bold;">${runStatusIcon}</span>
                                                    <span style="font-weight: 500;">Run #${runIdx + 1}</span>
                                                    <span class="score-badge ${runScoreClass}" style="font-size: 12px;">${runScore}%</span>
                                                    ${durationText}
                                                </div>
                                                ${scoreBreakdown}
                                                <div style="margin-top: 6px;">
                                                    <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 4px;">Actual Output:</div>
                                                    <div class="json-preview" style="font-size: 13px; max-height: 150px; overflow-y: auto;">${escapeHtml(run.actualOutput || "N/A")}</div>
                                                </div>
                                            </div>
                                        `;
                                        })
                                        .join("")}
                                </div>
                            `;
                            }

                            // Calculate aggregated metrics for test case
                            let tcMetricsSummary = "";
                            if (tc.runs && tc.runs.length > 0) {
                                const totalExpectedFound = tc.runs.reduce(
                                    (sum, r) => sum + (r.expectedFound || 0),
                                    0
                                );
                                const totalExpectedTotal = tc.runs.reduce(
                                    (sum, r) => sum + (r.expectedTotal || 0),
                                    0
                                );
                                const totalUnexpected = tc.runs.reduce(
                                    (sum, r) => sum + (r.unexpectedFound || 0),
                                    0
                                );
                                if (totalExpectedTotal > 0) {
                                    tcMetricsSummary = `<div style="margin-top: 8px; font-size: 13px; color: var(--color-text-muted);">
                                    Across ${tc.runs.length} run(s): 
                                    <span style="color: var(--color-success);">${totalExpectedFound}/${totalExpectedTotal} expected found</span>
                                    ${totalUnexpected > 0 ? `<span style="color: var(--color-failure); margin-left: 8px;">+${totalUnexpected} unexpected</span>` : ""}
                                </div>`;
                                }
                            }

                            // Horizontal run results summary when not showing individual runs
                            let runsSummaryHtml = "";
                            if (!showAllRuns && tc.runs && tc.runs.length > 0) {
                                runsSummaryHtml = `
                                <div style="margin-top: 12px;">
                                    <div style="font-size: 12px; color: var(--color-text-muted); margin-bottom: 8px;"><strong>Run Results:</strong></div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${tc.runs
                                            .map((run, runIdx) => {
                                                const runScore = AppUtils.scoreToPercent(
                                                    run.score || 0
                                                );
                                                const runScoreClass =
                                                    runScore >= 90
                                                        ? "success"
                                                        : runScore >= 80
                                                          ? "medium"
                                                          : "failure";
                                                const bgColor =
                                                    runScore >= 90
                                                        ? "rgba(34, 197, 94, 0.15)"
                                                        : runScore >= 80
                                                          ? "rgba(234, 179, 8, 0.15)"
                                                          : "rgba(239, 68, 68, 0.15)";
                                                const textColor =
                                                    runScore >= 90
                                                        ? "var(--color-success)"
                                                        : runScore >= 80
                                                          ? "var(--color-warning)"
                                                          : "var(--color-failure)";
                                                const icon = run.isCorrect
                                                    ? "‚úì"
                                                    : runScore >= 80
                                                      ? "‚óê"
                                                      : "‚úó";
                                                const compactDuration =
                                                    run.durationMs !== undefined
                                                        ? ` ¬∑ ${formatDuration(run.durationMs)}`
                                                        : "";
                                                return `<div style="display: flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; background: ${bgColor}; font-size: 12px;" title="Run #${runIdx + 1}: ${runScore}%${run.durationMs !== undefined ? ", " + formatDuration(run.durationMs) : ""}">
                                                <span style="color: ${textColor}; font-weight: bold;">${icon}</span>
                                                <span style="color: ${textColor};">${runScore}%${compactDuration}</span>
                                            </div>`;
                                            })
                                            .join("")}
                                    </div>
                                </div>
                            `;
                            }

                            // Calculate average duration for this test case
                            const tcDurations = tc.runs
                                .map((r) => r.durationMs)
                                .filter((d) => d !== undefined && d !== null);
                            const tcAvgDuration =
                                tcDurations.length > 0
                                    ? Math.round(
                                          tcDurations.reduce((a, b) => a + b, 0) /
                                              tcDurations.length
                                      )
                                    : null;
                            const tcAvgDurationHtml =
                                tcAvgDuration !== null
                                    ? `<span class="duration-badge" title="Average response time for this test case">‚è± ${formatDuration(tcAvgDuration)}</span>`
                                    : "";

                            return `
                            <div class="test-case-detail">
                                <div class="header">
                                    <strong>#${i + 1}</strong>
                                    <span class="score-badge ${scoreClass}">${avgScore}%</span>
                                    ${tcAvgDurationHtml}
                                </div>
                                ${tcMetricsSummary}
                                <div style="margin-top: 10px; margin-bottom: 5px;"><strong>Input:</strong></div>
                                <div class="json-preview">${escapeHtml(tc.input.substring(0, 200))}${tc.input.length > 200 ? "..." : ""}</div>
                                <div style="margin-top: 10px; margin-bottom: 5px;"><strong>Expected:</strong></div>
                                <div class="json-preview">${formatJSON(tc.expectedOutput)}</div>
                                ${runsSummaryHtml}
                                ${runsHtml}
                            </div>
                        `;
                        })
                        .join("");
            }

            function openTestDetailsModal(llmName) {
                const llm = storedLlmResults[llmName];
                if (!llm) return;

                const llmScorePercent = AppUtils.scoreToPercent(llm.score);
                const badgeClass =
                    llmScorePercent >= 90 ? "" : llmScorePercent >= 80 ? "medium" : "low";

                document.getElementById("test-details-llm-name").textContent = llm.llmName;
                document.getElementById("test-details-score-badge").className =
                    `score-badge ${badgeClass}`;
                document.getElementById("test-details-score-badge").textContent =
                    `${llmScorePercent}% avg score`;

                renderTestDetailsContent(llm);

                document.getElementById("test-details-modal").classList.add("active");
            }

            function closeTestDetailsModal() {
                document.getElementById("test-details-modal").classList.remove("active");
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            function formatJSON(json) {
                try {
                    return escapeHtml(JSON.stringify(JSON.parse(json), null, 2));
                } catch {
                    return escapeHtml(json);
                }
            }

            document.getElementById("run-btn").addEventListener("click", runTests);
            document.getElementById("runs-per-test").addEventListener("input", updateRunsDisplay);
            document
                .getElementById("test-details-close-btn")
                .addEventListener("click", closeTestDetailsModal);

            // Close modal on overlay click
            document.getElementById("test-details-modal").addEventListener("click", (e) => {
                if (e.target === e.currentTarget) closeTestDetailsModal();
            });

            // Close modal on Escape key
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    closeTestDetailsModal();
                }
            });

            // Initialize
            updateUI();
        </script>
    </body>
</html>
